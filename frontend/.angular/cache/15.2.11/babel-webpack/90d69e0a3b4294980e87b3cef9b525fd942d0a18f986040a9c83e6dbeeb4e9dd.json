{"ast":null,"code":"import _asyncToGenerator from \"/Users/marieklinaeva/github/ck-board/frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { fabric } from 'fabric';\nimport { PostType } from '../../models/post';\nimport { PostModalComponent } from '../post-modal/post-modal.component';\nimport { AddPostComponent } from '../add-post-modal/add-post.component';\nimport { Mode, POST_DEFAULT_OPACITY, POST_MOVING_FILL, POST_MOVING_OPACITY, SocketEvent, STUDENT_POST_COLOR } from 'src/app/utils/constants';\nimport { BoardScope, ViewType } from 'src/app/models/board';\nimport { Role } from 'src/app/models/user';\nimport { BucketsModalComponent } from '../buckets-modal/buckets-modal.component';\nimport { ListModalComponent } from '../list-modal/list-modal.component';\nimport { TaskModalComponent } from '../task-modal/task-modal.component';\nimport { getErrorMessage } from 'src/app/utils/Utils';\nimport { FabricPostComponent } from '../fabric-post/fabric-post.component';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../../services/post.service\";\nimport * as i2 from \"../../services/board.service\";\nimport * as i3 from \"src/app/services/user.service\";\nimport * as i4 from \"src/app/services/comment.service\";\nimport * as i5 from \"src/app/services/upvotes.service\";\nimport * as i6 from \"src/app/services/project.service\";\nimport * as i7 from \"src/app/utils/FabricUtils\";\nimport * as i8 from \"@angular/router\";\nimport * as i9 from \"src/app/services/snackbar.service\";\nimport * as i10 from \"@angular/material/dialog\";\nimport * as i11 from \"src/app/services/fileUpload.service\";\nimport * as i12 from \"src/app/services/socket.service\";\nimport * as i13 from \"src/app/services/canvas.service\";\nimport * as i14 from \"src/app/services/trace.service\";\nfunction CanvasComponent_app_toolbar_2_span_1_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\", 25);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r7 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(1);\n    i0.ɵɵtextInterpolate(ctx_r7.board.name);\n  }\n}\nfunction CanvasComponent_app_toolbar_2_button_5_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r11 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"button\", 26);\n    i0.ɵɵlistener(\"click\", function CanvasComponent_app_toolbar_2_button_5_Template_button_click_0_listener() {\n      i0.ɵɵrestoreView(_r11);\n      const ctx_r10 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r10.board.scope === ctx_r10.BoardScope.PROJECT_SHARED ? ctx_r10.copyEmbedCode() : ctx_r10.copyPersonalEmbedCode());\n    });\n    i0.ɵɵelementStart(1, \"mat-icon\");\n    i0.ɵɵtext(2, \"file_copy\");\n    i0.ɵɵelementEnd()();\n  }\n}\nfunction CanvasComponent_app_toolbar_2_div_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\");\n    i0.ɵɵelement(1, \"app-notification-dropdown\", 27);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r9 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"user\", ctx_r9.user)(\"board\", ctx_r9.board);\n  }\n}\nfunction CanvasComponent_app_toolbar_2_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r13 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"app-toolbar\", 17);\n    i0.ɵɵtemplate(1, CanvasComponent_app_toolbar_2_span_1_Template, 2, 1, \"span\", 18);\n    i0.ɵɵelementStart(2, \"button\", 19);\n    i0.ɵɵlistener(\"click\", function CanvasComponent_app_toolbar_2_Template_button_click_2_listener() {\n      i0.ɵɵrestoreView(_r13);\n      const ctx_r12 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r12.openTaskDialog());\n    });\n    i0.ɵɵelementStart(3, \"mat-icon\");\n    i0.ɵɵtext(4, \"task\");\n    i0.ɵɵelementEnd()();\n    i0.ɵɵtemplate(5, CanvasComponent_app_toolbar_2_button_5_Template, 3, 0, \"button\", 20);\n    i0.ɵɵelement(6, \"span\", 21)(7, \"app-view-navigation\", 22);\n    i0.ɵɵtemplate(8, CanvasComponent_app_toolbar_2_div_8_Template, 2, 2, \"div\", 23);\n    i0.ɵɵelement(9, \"app-toolbar-menu\", 24);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext();\n    i0.ɵɵproperty(\"user\", ctx_r0.user);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", ctx_r0.board && ctx_r0.board.name);\n    i0.ɵɵadvance(4);\n    i0.ɵɵproperty(\"ngIf\", ctx_r0.user.role === ctx_r0.Role.TEACHER);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"boardID\", ctx_r0.boardID)(\"currentView\", ctx_r0.viewType);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", ctx_r0.board);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"board\", ctx_r0.board)(\"project\", ctx_r0.project);\n  }\n}\nfunction CanvasComponent_div_5_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 28);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(1);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r1.board.name, \" \");\n  }\n}\nfunction CanvasComponent_div_6_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 29)(1, \"a\", 30);\n    i0.ɵɵtext(2, \"Back to Project\");\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(1);\n    i0.ɵɵpropertyInterpolate(\"routerLink\", \"/project/\" + ctx_r2.projectID);\n  }\n}\nfunction CanvasComponent_button_12_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r15 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"button\", 31);\n    i0.ɵɵlistener(\"click\", function CanvasComponent_button_12_Template_button_click_0_listener() {\n      i0.ɵɵrestoreView(_r15);\n      const ctx_r14 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r14.handleCreatePost());\n    });\n    i0.ɵɵelementStart(1, \"mat-icon\");\n    i0.ɵɵtext(2, \"add\");\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r3 = i0.ɵɵnextContext();\n    i0.ɵɵproperty(\"disabled\", ctx_r3.board && ctx_r3.user && !ctx_r3.board.permissions.allowStudentEditAddDeletePost && ctx_r3.user.role === ctx_r3.Role.STUDENT);\n  }\n}\nfunction CanvasComponent_button_13_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r17 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"button\", 32);\n    i0.ɵɵlistener(\"click\", function CanvasComponent_button_13_Template_button_click_0_listener() {\n      i0.ɵɵrestoreView(_r17);\n      const ctx_r16 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r16.disableChooseLocation());\n    });\n    i0.ɵɵelementStart(1, \"mat-icon\");\n    i0.ɵɵtext(2, \"close\");\n    i0.ɵɵelementEnd()();\n  }\n}\nfunction CanvasComponent_button_14_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r19 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"button\", 33);\n    i0.ɵɵlistener(\"click\", function CanvasComponent_button_14_Template_button_click_0_listener() {\n      i0.ɵɵrestoreView(_r19);\n      const ctx_r18 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r18.enablePanMode());\n    });\n    i0.ɵɵelementStart(1, \"span\", 34);\n    i0.ɵɵtext(2, \" arrow_selector_tool \");\n    i0.ɵɵelementEnd()();\n  }\n}\nfunction CanvasComponent_button_15_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r21 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"button\", 35);\n    i0.ɵɵlistener(\"click\", function CanvasComponent_button_15_Template_button_click_0_listener() {\n      i0.ɵɵrestoreView(_r21);\n      const ctx_r20 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r20.enableEditMode());\n    });\n    i0.ɵɵelementStart(1, \"mat-icon\", 36);\n    i0.ɵɵtext(2, \"pan_tool\");\n    i0.ɵɵelementEnd()();\n  }\n}\nexport class CanvasComponent {\n  onMouseWheel(e) {\n    e.preventDefault();\n    e.stopPropagation();\n  }\n  constructor(postService, boardService, userService, commentService, upvotesService, projectService, fabricUtils, router, activatedRoute, snackbarService, dialog, fileUploadService, socketService, canvasService, traceService) {\n    var _this = this;\n    this.postService = postService;\n    this.boardService = boardService;\n    this.userService = userService;\n    this.commentService = commentService;\n    this.upvotesService = upvotesService;\n    this.projectService = projectService;\n    this.fabricUtils = fabricUtils;\n    this.router = router;\n    this.activatedRoute = activatedRoute;\n    this.snackbarService = snackbarService;\n    this.dialog = dialog;\n    this.fileUploadService = fileUploadService;\n    this.socketService = socketService;\n    this.canvasService = canvasService;\n    this.traceService = traceService;\n    this.Math = Math;\n    this.initialClientX = 0;\n    this.initialClientY = 0;\n    this.finalClientX = 0;\n    this.finalClientY = 0;\n    this.embedded = false;\n    this.numSavedPosts = 0;\n    this.zoom = 1;\n    this.ctrlPressed = false;\n    this.rightClickDown = false;\n    this.mode = Mode.EDIT;\n    this.prevMode = Mode.EDIT;\n    this.modeType = Mode;\n    this.Role = Role;\n    this.BoardScope = BoardScope;\n    this.showList = false;\n    this.showBuckets = false;\n    this.showAddPost = true;\n    this.lockArrowKeys = false;\n    this.upvoteCounter = 0;\n    this.unsubListeners = [];\n    this.viewType = ViewType.CANVAS;\n    this.handlePostCreateEvent = post => {\n      if (post.type === PostType.BOARD) {\n        const fabricPost = new FabricPostComponent(post);\n        this.canvas.add(fabricPost);\n      }\n    };\n    this.handlePostUpdateEvent = post => {\n      let existing = this.fabricUtils.getObjectFromId(post.postID);\n      if (existing) {\n        existing = this.fabricUtils.updatePostTitleDesc(existing, post.title, post.desc);\n        this.canvas.requestRenderAll();\n      }\n    };\n    this.handlePostDeleteEvent = id => {\n      const obj = this.fabricUtils.getObjectFromId(id);\n      if (obj) {\n        this.canvas.remove(obj);\n      }\n      this._calcUpvoteCounter();\n    };\n    this.handleWorkflowRun = data => {\n      if (data) {\n        data.forEach(postID => this.handlePostDeleteEvent(postID));\n      }\n    };\n    this.handleWorkflowPost = postID => {\n      this.handlePostDeleteEvent(postID);\n    };\n    this.handlePostStartMoveEvent = post => {\n      let obj = this.fabricUtils.getObjectFromId(post.postID);\n      obj = this.fabricUtils.setFillColor(obj, POST_MOVING_FILL);\n      obj = this.fabricUtils.setOpacity(obj, POST_MOVING_OPACITY);\n      obj = this.fabricUtils.setPostMovement(obj, true);\n      this.canvas.requestRenderAll();\n    };\n    this.handlePostStopMoveEvent = post => {\n      var _a;\n      if (!((_a = post.displayAttributes) === null || _a === void 0 ? void 0 : _a.position)) return;\n      let existing = this.fabricUtils.getObjectFromId(post.postID);\n      const {\n        left,\n        top\n      } = post.displayAttributes.position;\n      this.fabricUtils.animateToPosition(existing, left, top, /*#__PURE__*/_asyncToGenerator(function* () {\n        const fill = yield _this.fabricUtils.defaultPostColor(post.userID);\n        existing = _this.fabricUtils.setFillColor(existing, fill !== null && fill !== void 0 ? fill : STUDENT_POST_COLOR);\n        existing = _this.fabricUtils.setOpacity(existing, POST_DEFAULT_OPACITY);\n        existing = _this.fabricUtils.setPostMovement(existing, !_this._postsMovementAllowed());\n        existing.setCoords();\n        _this.canvas.renderAll();\n      }));\n    };\n    this.handlePostUpvoteAddEvent = result => {\n      if (result.upvote.voterID == this.user.userID) this.upvoteCounter -= 1;\n      let existing = this.fabricUtils.getObjectFromId(result.upvote.postID);\n      if (existing) {\n        existing = this.fabricUtils.setUpvoteCount(existing, result.amount);\n        this.canvas.requestRenderAll();\n      }\n    };\n    this.handlePostUpvoteRemoveEvent = result => {\n      if (result.upvote.voterID == this.user.userID) this.upvoteCounter += 1;\n      let existing = this.fabricUtils.getObjectFromId(result.upvote.postID);\n      if (existing) {\n        existing = this.fabricUtils.setUpvoteCount(existing, result.amount);\n        this.canvas.requestRenderAll();\n      }\n    };\n    this.handlePostCommentAddEvent = result => {\n      let existing = this.fabricUtils.getObjectFromId(result.comment.postID);\n      if (existing) {\n        existing = this.fabricUtils.setCommentCount(existing, result.amount);\n        this.canvas.requestRenderAll();\n      }\n    };\n    this.handlePostCommentRemoveEvent = result => {\n      let existing = this.fabricUtils.getObjectFromId(result.comment.postID);\n      if (existing) {\n        existing = this.fabricUtils.setCommentCount(existing, result.amount);\n        this.canvas.requestRenderAll();\n      }\n    };\n    this.handlePostTagAddEvent = ({\n      post,\n      tag\n    }) => {\n      const existing = this.fabricUtils.getObjectFromId(post.postID);\n      if (existing) {\n        this.fabricUtils.applyTagFeatures(existing, tag);\n      }\n    };\n    this.handlePostTagRemoveEvent = ({\n      post,\n      tag\n    }) => {\n      const existing = this.fabricUtils.getObjectFromId(post.postID);\n      if (post.specialAttributes && existing) {\n        this.fabricUtils.resetTagFeatures(existing);\n      }\n    };\n    this.handleBoardNameUpdateEvent = board => {\n      this.board = board;\n    };\n    this.handleBoardImageUpdateEvent = board => {\n      var _a, _b;\n      this.board = board;\n      this.fabricUtils.setBackgroundImage((_a = board.bgImage) === null || _a === void 0 ? void 0 : _a.url, (_b = board.bgImage) === null || _b === void 0 ? void 0 : _b.imgSettings);\n    };\n    this.handleBoardPermsUpdateEvent = board => {\n      this.board = board;\n      this.updateShowAddPost(board.permissions);\n      this.lockPostsMovement(!board.permissions.allowStudentMoveAny && this.user.role == Role.STUDENT);\n      this.setAuthorVisibilityAll();\n      this.traceService.setTraceContext(this.projectID, this.boardID);\n    };\n    this.handleBoardTagsUpdateEvent = board => {\n      this.board = board;\n    };\n    this.handleBoardTaskUpdateEvent = board => {\n      this.board = board;\n    };\n    this.handleBoardUpvoteUpdateEvent = board => {\n      this.board = board;\n      this._calcUpvoteCounter();\n    };\n    this.handleVotesClearEvent = /*#__PURE__*/function () {\n      var _ref2 = _asyncToGenerator(function* (result) {\n        _this._calcUpvoteCounter();\n        const resetedPosts = [];\n        for (const upvotes of result) {\n          if (!resetedPosts.includes(upvotes.postID)) {\n            let existing = _this.fabricUtils.getObjectFromId(upvotes.postID);\n            if (existing) {\n              existing = _this.fabricUtils.setUpvoteCount(existing, 0);\n              _this.canvas.requestRenderAll();\n              resetedPosts.push(upvotes.postID);\n            }\n          }\n        }\n      });\n      return function (_x) {\n        return _ref2.apply(this, arguments);\n      };\n    }();\n    this.handleBoardClearEvent = ids => {\n      ids.forEach(id => {\n        this.handlePostDeleteEvent(id);\n      });\n    };\n    this.handleBoardConnEvent = () => {\n      if (this.user.role === Role.TEACHER) return;\n      this.router.navigate(['/error'], {\n        state: {\n          code: 403,\n          message: 'You do not have access to this board!'\n        }\n      });\n    };\n    this.handlePersonalBoardAddPost = postData => {\n      if (postData.post.type === PostType.BOARD && this.board.scope === BoardScope.PROJECT_PERSONAL) {\n        const fabricPost = new FabricPostComponent(postData.post);\n        this.canvas.add(fabricPost);\n      }\n    };\n    this.handleChoosePostLocation = opt => {\n      if (opt.target == null) {\n        this.canvas.selection = false;\n        this._openDialog(AddPostComponent, {\n          type: PostType.BOARD,\n          board: this.board,\n          user: this.user,\n          spawnPosition: {\n            top: opt.absolutePointer ? opt.absolutePointer.y : 150,\n            left: opt.absolutePointer ? opt.absolutePointer.x : 150\n          }\n        });\n      }\n      this.snackbarService.dequeueSnackbar();\n      this.canvas.off('mouse:down', this.handleChoosePostLocation);\n      this.enableEditMode();\n    };\n    this.handleUpvoteClick = /*#__PURE__*/function () {\n      var _ref3 = _asyncToGenerator(function* (e) {\n        var _a;\n        const post = e.target;\n        const upvoteButton = (_a = e.subTargets) === null || _a === void 0 ? void 0 : _a.find(o => o.name == 'upvote');\n        if (upvoteButton && _this._votingAllowed()) {\n          _this.canvasService.upvote(_this.user.userID, post.postID).catch(e => _this.snackbarService.queueSnackbar(getErrorMessage(e)));\n        }\n      });\n      return function (_x2) {\n        return _ref3.apply(this, arguments);\n      };\n    }();\n    this.handleDownvoteClick = /*#__PURE__*/function () {\n      var _ref4 = _asyncToGenerator(function* (e) {\n        var _a;\n        const post = e.target;\n        const upvoteButton = (_a = e.subTargets) === null || _a === void 0 ? void 0 : _a.find(o => o.name == 'downvote');\n        if (upvoteButton && _this._votingAllowed()) {\n          _this.canvasService.unupvote(_this.user.userID, post.postID).catch(e => _this.snackbarService.queueSnackbar(getErrorMessage(e)));\n        }\n      });\n      return function (_x3) {\n        return _ref4.apply(this, arguments);\n      };\n    }();\n    this.groupEventToHandler = new Map([[SocketEvent.POST_CREATE, this.handlePostCreateEvent], [SocketEvent.POST_UPDATE, this.handlePostUpdateEvent], [SocketEvent.POST_DELETE, this.handlePostDeleteEvent], [SocketEvent.POST_START_MOVE, this.handlePostStartMoveEvent], [SocketEvent.POST_STOP_MOVE, this.handlePostStopMoveEvent], [SocketEvent.POST_UPVOTE_ADD, this.handlePostUpvoteAddEvent], [SocketEvent.POST_UPVOTE_REMOVE, this.handlePostUpvoteRemoveEvent], [SocketEvent.POST_COMMENT_ADD, this.handlePostCommentAddEvent], [SocketEvent.POST_COMMENT_REMOVE, this.handlePostCommentRemoveEvent], [SocketEvent.POST_TAG_ADD, this.handlePostTagAddEvent], [SocketEvent.POST_TAG_REMOVE, this.handlePostTagRemoveEvent], [SocketEvent.BOARD_NAME_UPDATE, this.handleBoardNameUpdateEvent], [SocketEvent.BOARD_IMAGE_UPDATE, this.handleBoardImageUpdateEvent], [SocketEvent.BOARD_PERMISSIONS_UPDATE, this.handleBoardPermsUpdateEvent], [SocketEvent.BOARD_TAGS_UPDATE, this.handleBoardTagsUpdateEvent], [SocketEvent.BOARD_TASK_UPDATE, this.handleBoardTaskUpdateEvent], [SocketEvent.BOARD_UPVOTE_UPDATE, this.handleBoardUpvoteUpdateEvent], [SocketEvent.VOTES_CLEAR, this.handleVotesClearEvent], [SocketEvent.BOARD_CLEAR, this.handleBoardClearEvent], [SocketEvent.WORKFLOW_RUN_DISTRIBUTION, this.handleWorkflowRun], [SocketEvent.WORKFLOW_POST_SUBMIT, this.handleWorkflowPost], [SocketEvent.BOARD_CONN_UPDATE, this.handleBoardConnEvent]]);\n  }\n  ngOnInit() {\n    var _this2 = this;\n    return _asyncToGenerator(function* () {\n      _this2.activatedRoute.queryParams.subscribe(params => {\n        if (params.embedded == 'true') {\n          _this2.embedded = true;\n        }\n      });\n      _this2.user = _this2.userService.user;\n      _this2.canvas = new fabric.Canvas('canvas', _this2.embedded ? _this2.fabricUtils.embeddedCanvasConfig : _this2.fabricUtils.canvasConfig);\n      _this2.fabricUtils._canvas = _this2.canvas;\n      yield _this2.configureBoard();\n      _this2.socketService.connect(_this2.user.userID, _this2.boardID);\n      _this2.initCanvasEventsListener();\n      _this2.initGroupEventsListener();\n      window.onbeforeunload = () => _this2.ngOnDestroy();\n    })();\n  }\n  initCanvasEventsListener() {\n    const unsubCtrl = this.initCtrlKeyListener();\n    const unsubMoving = this.initMovingPostListener();\n    const unsubExpand = this.initPostClickListener();\n    const unsubUpvote = this.initUpvoteClickListener();\n    const unsubZoom = this.initZoomListener();\n    const unsubPan = this.initPanListener();\n    const unsubSwipePan = this.initPanSwipeListener();\n    const unsubKeyPan = this.initKeyPanningListener();\n    const unsubModal = this.hideListsWhenModalOpen();\n    const unsubArrowKeyLock = this.lockArrowKeysWhenModalOpen();\n    const unsubArrowKeyUnlock = this.unlockArrowKeysWhenModalClose();\n    return [unsubCtrl, unsubUpvote, unsubExpand, unsubModal, unsubMoving, unsubZoom, unsubPan, unsubSwipePan, unsubKeyPan, unsubArrowKeyLock, unsubArrowKeyUnlock];\n  }\n  initGroupEventsListener() {\n    for (const [k, v] of this.groupEventToHandler) {\n      const unsub = this.socketService.listen(k, v);\n      this.unsubListeners.push(unsub);\n    }\n  }\n  showBucketsModal() {\n    this._openDialog(BucketsModalComponent, {\n      board: this.board,\n      user: this.user,\n      centerX: this.canvas.getCenter().left,\n      centerY: this.canvas.getCenter().top\n    }, '95vw');\n  }\n  showListModal() {\n    this._openDialog(ListModalComponent, {\n      board: this.board,\n      user: this.user,\n      centerX: this.canvas.getCenter().left,\n      centerY: this.canvas.getCenter().top\n    }, '95vw');\n  }\n  intermediateBoardConfig(board) {\n    var _a, _b;\n    this.board = board;\n    this._calcUpvoteCounter();\n    this.configureZoom();\n    this.fabricUtils.setBackgroundImage((_a = board.bgImage) === null || _a === void 0 ? void 0 : _a.url, (_b = board.bgImage) === null || _b === void 0 ? void 0 : _b.imgSettings);\n    this.lockPostsMovement(!board.permissions.allowStudentMoveAny && this.user.role == Role.STUDENT);\n    this.updateShowAddPost(this.board.permissions);\n    this.setAuthorVisibilityAll();\n    if (this.board.permissions.showSnackBarStudent) {\n      this.openTaskDialog();\n    }\n  }\n  configureBoard() {\n    var _this3 = this;\n    return _asyncToGenerator(function* () {\n      var _a, _b, _c;\n      const map = _this3.activatedRoute.snapshot.paramMap;\n      if (map.has('boardID') && map.has('projectID')) {\n        _this3.boardID = (_a = _this3.activatedRoute.snapshot.paramMap.get('boardID')) !== null && _a !== void 0 ? _a : '';\n        _this3.projectID = (_b = _this3.activatedRoute.snapshot.paramMap.get('projectID')) !== null && _b !== void 0 ? _b : '';\n        _this3.traceService.setTraceContext(_this3.projectID, _this3.boardID);\n        _this3.postService.getAllByBoard(_this3.boardID).then(data => {\n          data.forEach( /*#__PURE__*/function () {\n            var _ref5 = _asyncToGenerator(function* (post) {\n              if (post.type == PostType.BOARD) {\n                const upvotes = yield _this3.upvotesService.getUpvotesByPost(post.postID);\n                const comments = yield _this3.commentService.getCommentsByPost(post.postID);\n                _this3.canvas.add(new FabricPostComponent(post, {\n                  upvotes: upvotes.length,\n                  comments: comments.length\n                }));\n              }\n            });\n            return function (_x4) {\n              return _ref5.apply(this, arguments);\n            };\n          }());\n          _this3.boardService.get(_this3.boardID).then(board => {\n            var _a, _b;\n            if (board) _this3.intermediateBoardConfig(board);\n            if (_this3.board && !((_a = _this3.board.viewSettings) === null || _a === void 0 ? void 0 : _a.allowCanvas)) {\n              _this3.router.navigateByUrl(`project/${_this3.projectID}/board/${_this3.boardID}/${(_b = _this3.board.defaultView) === null || _b === void 0 ? void 0 : _b.toLowerCase()}`);\n            }\n          });\n        });\n      } else if (map.has('projectID')) {\n        _this3.projectID = (_c = _this3.activatedRoute.snapshot.paramMap.get('projectID')) !== null && _c !== void 0 ? _c : '';\n        const personalBoard = yield _this3.boardService.getPersonal(_this3.projectID);\n        if (personalBoard) {\n          _this3.boardID = personalBoard.boardID;\n          _this3.traceService.setTraceContext(_this3.projectID, _this3.boardID);\n        } else _this3.router.navigate(['error']);\n        _this3.postService.getAllByBoard(_this3.boardID).then(data => {\n          data.forEach( /*#__PURE__*/function () {\n            var _ref6 = _asyncToGenerator(function* (post) {\n              if (post.type == PostType.BOARD) {\n                const upvotes = yield _this3.upvotesService.getUpvotesByPost(post.postID);\n                const comments = yield _this3.commentService.getCommentsByPost(post.postID);\n                _this3.canvas.add(new FabricPostComponent(post, {\n                  upvotes: upvotes.length,\n                  comments: comments.length\n                }));\n              }\n            });\n            return function (_x5) {\n              return _ref6.apply(this, arguments);\n            };\n          }());\n          if (personalBoard) _this3.intermediateBoardConfig(personalBoard);\n        });\n      } else {\n        _this3.router.navigate(['error']);\n      }\n      _this3.projectService.get(_this3.projectID).then(project => _this3.project = project);\n    })();\n  }\n  // TODO: handle board update from toolbar-menu\n  configureZoom() {\n    if (this.board.initialZoom) {\n      const zoom = this.board.initialZoom / 100;\n      this.zoom = parseFloat(zoom.toPrecision(2));\n      this.handleZoom('setZoom');\n    } else {\n      this.zoom = 1;\n    }\n  }\n  // open dialog to get message for a new post\n  handleCreatePost() {\n    this.mode = Mode.CHOOSING_LOCATION;\n    this.canvas.defaultCursor = 'copy';\n    this.canvas.hoverCursor = 'not-allowed';\n    this.snackbarService.queueSnackbar('Click where you want the post to be created!');\n    this.canvas.on('mouse:down', this.handleChoosePostLocation);\n  }\n  disableChooseLocation() {\n    this.snackbarService.dequeueSnackbar();\n    this.canvas.off('mouse:down', this.handleChoosePostLocation);\n    this.enableEditMode();\n  }\n  lockPostsMovement(value) {\n    this.canvas.getObjects().map(obj => {\n      obj.set({\n        lockMovementX: value,\n        lockMovementY: value\n      });\n    });\n    this.canvas.renderAll();\n  }\n  onResize(event) {\n    const scaleX = event.target.innerWidth / this.canvas.getWidth();\n    // Without toolbar height\n    const scaleY = (event.target.innerHeight - 64) / this.canvas.getHeight();\n    const objects = this.canvas.getObjects();\n    // Resize all objects inside the canvas\n    for (const i in objects) {\n      objects[i].scaleX = objects[i].getObjectScaling().scaleX * scaleY;\n      objects[i].scaleY = objects[i].getObjectScaling().scaleY * scaleY;\n      objects[i].left = (objects[i].left || 0) * scaleX;\n      objects[i].top = (objects[i].top || 0) * scaleY;\n      objects[i].setCoords();\n    }\n    this.canvas.setWidth(event.target.innerWidth);\n    // Without toolbar height\n    this.canvas.setHeight(event.target.innerHeight - 64);\n    this.canvas.renderAll();\n    this.canvas.calcOffset();\n  }\n  hideAuthorNames() {\n    this.canvas.getObjects().map(obj => {\n      this.fabricUtils.updateAuthor(obj, 'Anonymous');\n    });\n    this.canvas.renderAll();\n  }\n  updateAuthorNames(postID, username) {\n    const obj = this.fabricUtils.getObjectFromId(postID);\n    if (obj) {\n      this.fabricUtils.updateAuthor(obj, username);\n      this.canvas.renderAll();\n    }\n  }\n  setAuthorVisibilityOne(post) {\n    if (!this.board) {\n      return;\n    }\n    const isStudentAndVisible = this.user.role == Role.STUDENT && this.board.permissions.showAuthorNameStudent;\n    const IsTeacherAndVisisble = this.user.role == Role.TEACHER && this.board.permissions.showAuthorNameTeacher;\n    if (!(isStudentAndVisible || IsTeacherAndVisisble)) {\n      this.updateAuthorNames(post.postID, 'Anonymous');\n    } else {\n      console.log('can');\n      this.userService.getOneById(post.userID).then(user => {\n        this.updateAuthorNames(post.postID, user.username);\n      });\n    }\n  }\n  setAuthorVisibilityAll() {\n    this.postService.getAllByBoard(this.boardID).then(data => {\n      // update all the post names to to the poster's name rather than anonymous\n      data.forEach(post => {\n        this.setAuthorVisibilityOne(post);\n      });\n    });\n  }\n  updateShowAddPost(permissions) {\n    const isStudent = this.user.role == Role.STUDENT;\n    const isTeacher = this.user.role == Role.TEACHER;\n    this.showAddPost = isStudent && permissions.allowStudentEditAddDeletePost || isTeacher;\n  }\n  openTaskDialog() {\n    if (!this.board.task) return;\n    const title = this.board.task.title ? this.board.task.title : 'No task created!';\n    const message = this.board.task.message;\n    if (this.snackbarService.snackbarIsOpen()) {\n      this.snackbarService.dequeueSnackbar();\n      return;\n    }\n    const openDialogCloseSnack = () => {\n      this._openDialog(TaskModalComponent, {\n        title: title,\n        message: message\n      });\n      this.snackbarService.dequeueSnackbar();\n    };\n    this.snackbarService.queueSnackbar(title, message, {\n      action: {\n        name: 'View Full Task',\n        run: openDialogCloseSnack\n      },\n      matSnackbarConfig: {\n        verticalPosition: 'bottom',\n        horizontalPosition: 'center',\n        panelClass: ['wide-snackbar']\n      }\n    });\n  }\n  initUpvoteClickListener() {\n    this.canvas.on('mouse:down', this.handleUpvoteClick);\n    this.canvas.on('mouse:down', this.handleDownvoteClick);\n    return () => {\n      this.canvas.off('mouse:down', this.handleUpvoteClick);\n      this.canvas.off('mouse:down', this.handleDownvoteClick);\n    };\n  }\n  initCtrlKeyListener() {\n    document.addEventListener('keydown', event => {\n      /* Switch to pan mode on Ctrl press, only if not already holding right-click down */\n      if (!this.rightClickDown && event.key === 'Control') {\n        this.ctrlPressed = true;\n        this.prevMode = this.mode;\n        this.enablePanMode();\n      }\n    });\n    document.addEventListener('keyup', event => {\n      if (event.key === 'Control') {\n        this.ctrlPressed = false;\n        if (this.prevMode === Mode.EDIT) {\n          this.enableEditMode();\n        }\n      }\n    });\n    return () => {\n      if (document.removeAllListeners) {\n        document.removeAllListeners('keydown');\n        document.removeAllListeners('keyup');\n      }\n    };\n  }\n  initPostClickListener() {\n    let isDragging = false;\n    let isMouseDown = false;\n    const postClickHandler = e => {\n      var _a;\n      if (((_a = e.target) === null || _a === void 0 ? void 0 : _a.name) == 'post') isMouseDown = true;\n    };\n    const postMovingHandler = e => {\n      var _a;\n      if (((_a = e.target) === null || _a === void 0 ? void 0 : _a.name) == 'post') isDragging = isMouseDown;\n    };\n    const mouseUpHandler = e => {\n      var _a, _b;\n      const obj = e.target;\n      const votePress = (_a = e.subTargets) === null || _a === void 0 ? void 0 : _a.find(o => o.name == 'upvote' || o.name == 'downvote');\n      const commentPress = (_b = e.subTargets) === null || _b === void 0 ? void 0 : _b.find(o => o.name == 'comment');\n      const isDragEnd = isDragging;\n      isDragging = false;\n      isMouseDown = false;\n      if (!isDragEnd && !votePress && (obj === null || obj === void 0 ? void 0 : obj.name) == 'post') {\n        this.canvas.discardActiveObject().renderAll();\n        this._openDialog(PostModalComponent, {\n          user: this.user,\n          post: obj,\n          board: this.board,\n          commentPress: commentPress,\n          numSavedPosts: this.numSavedPosts,\n          updateNumSavedPosts: num => {\n            this.numSavedPosts = num;\n          }\n        });\n        this.canvasService.readPost(obj.postID);\n      }\n    };\n    this.canvas.on('mouse:down', postClickHandler);\n    this.canvas.on('mouse:move', postMovingHandler);\n    this.canvas.on('mouse:up', mouseUpHandler);\n    return () => {\n      this.canvas.off('mouse:down', postClickHandler);\n      this.canvas.off('mouse:move', postMovingHandler);\n      this.canvas.off('mouse:up', mouseUpHandler);\n    };\n  }\n  initMovingPostListener() {\n    var _this4 = this;\n    let isMovingPost = false;\n    const handleFirstMove = e => {\n      if (e.target && !isMovingPost) {\n        let obj = e.target;\n        isMovingPost = true;\n        obj = this.fabricUtils.setFillColor(obj, POST_MOVING_FILL);\n        obj = this.fabricUtils.setOpacity(obj, POST_MOVING_OPACITY);\n        this.canvas.renderAll();\n        this.socketService.emit(SocketEvent.POST_START_MOVE, {\n          postID: obj.postID\n        });\n      }\n    };\n    const handleDroppedPost = /*#__PURE__*/function () {\n      var _ref7 = _asyncToGenerator(function* (e) {\n        if (!isMovingPost) return;\n        let obj = e.target;\n        isMovingPost = false;\n        const fill = yield _this4.fabricUtils.defaultPostColor(obj.userID);\n        obj = _this4.fabricUtils.setFillColor(obj, fill !== null && fill !== void 0 ? fill : STUDENT_POST_COLOR);\n        obj = _this4.fabricUtils.setOpacity(obj, POST_DEFAULT_OPACITY);\n        _this4.canvas.renderAll();\n        _this4.socketService.emit(SocketEvent.POST_STOP_MOVE, {\n          postID: obj.postID,\n          left: obj.left,\n          top: obj.top\n        });\n      });\n      return function handleDroppedPost(_x6) {\n        return _ref7.apply(this, arguments);\n      };\n    }();\n    this.canvas.on('object:moving', handleFirstMove);\n    this.canvas.on('mouse:up', handleDroppedPost);\n    return () => {\n      this.canvas.off('object:moving', handleFirstMove);\n      this.canvas.off('mouse:up', handleDroppedPost);\n    };\n  }\n  initZoomListener() {\n    const handleZoomEvent = opt => {\n      const options = opt.e;\n      // Condition for pinch gesture on trackpad:\n      // 1. delta Y is an integer or delta X is 0\n      // 2. ctrl key is triggered\n      const trackpad_pinch = (Number.isInteger(options.deltaY) || Math.abs(options.deltaX) < 1e-9) && options.ctrlKey;\n      // Condition for mousewheel:\n      // 1. delta Y has trailing non-zero decimal points\n      // 2. delta X is zero\n      // 3. ctrl key is not triggered\n      const mousewheel = !(Math.abs(options.deltaY - Math.floor(options.deltaY)) < 1e-9) && Math.abs(options.deltaX) < 1e-9 && !options.ctrlKey;\n      if (trackpad_pinch || mousewheel) {\n        const delta = options.deltaY;\n        if (mousewheel) {\n          this.zoom *= 0.999 ** delta;\n        } else {\n          this.zoom *= 0.99 ** delta;\n        }\n        if (this.zoom > 20) this.zoom = 20;\n        if (this.zoom < 0.01) this.zoom = 0.01;\n        this.canvas.zoomToPoint(new fabric.Point(options.offsetX, options.offsetY), this.zoom);\n        opt.e.preventDefault();\n        opt.e.stopPropagation();\n      }\n    };\n    this.canvas.on('mouse:wheel', handleZoomEvent);\n    return () => {\n      this.canvas.off('mouse:wheel', handleZoomEvent);\n    };\n  }\n  initPanListener() {\n    let isPanning = false;\n    const mouseDown = opt => {\n      const {\n        e: options\n      } = opt;\n      /* Switch to pan mode on right-click, only if ctrl is not already pressed */\n      if (!this.ctrlPressed && (options.button === 2 || options.which === 3)) {\n        this.prevMode = this.mode;\n        this.enablePanMode();\n        this.rightClickDown = true;\n      }\n      if (this.mode == Mode.PAN) {\n        isPanning = true;\n        this.canvas.selection = false;\n        const options = opt.e;\n        this.initialClientX = options.clientX;\n        this.initialClientY = options.clientY;\n      }\n    };\n    const mouseUp = opt => {\n      if (this.rightClickDown) {\n        this.rightClickDown = false;\n        if (this.prevMode === Mode.EDIT) {\n          this.enableEditMode();\n        }\n      }\n      isPanning = false;\n      this.canvas.selection = true;\n      const options = opt.e;\n      this.initialClientX = options.clientX;\n      this.initialClientY = options.clientY;\n    };\n    const handlePan = opt => {\n      const options = opt.e;\n      if (isPanning && options) {\n        const delta = new fabric.Point(options.movementX, options.movementY);\n        this.canvas.relativePan(delta);\n        this.finalClientX = options.clientX;\n        this.finalClientY = options.clientY;\n      }\n    };\n    this.canvas.on('mouse:down', mouseDown);\n    this.canvas.on('mouse:up', mouseUp);\n    this.canvas.on('mouse:move', handlePan);\n    return () => {\n      this.canvas.off('mouse:down', mouseDown);\n      this.canvas.off('mouse:up', mouseUp);\n      this.canvas.off('mouse:move', handlePan);\n    };\n  }\n  initPanSwipeListener() {\n    const handlePanSwipe = opt => {\n      const options = opt.e;\n      // Condition for two-finger swipe on trackpad:\n      // 1. delta Y is an integer,\n      // 2. delta X is an integer,\n      // 3. ctrl key is not triggered\n      const trackpad_twofinger = Number.isInteger(options.deltaY) && Number.isInteger(options.deltaX) && !options.ctrlKey;\n      if (trackpad_twofinger) {\n        const vpt = this.canvas.viewportTransform;\n        if (!vpt) return;\n        vpt[4] -= options.deltaX;\n        vpt[5] -= options.deltaY;\n        this.canvas.setViewportTransform(vpt);\n        this.canvas.requestRenderAll();\n      }\n    };\n    this.canvas.on('mouse:wheel', handlePanSwipe);\n    return () => {\n      this.canvas.off('mouse:wheel', handlePanSwipe);\n    };\n  }\n  initKeyPanningListener() {\n    document.addEventListener('keydown', event => {\n      if (!this.lockArrowKeys) {\n        if (event.key == 'ArrowUp') {\n          event.preventDefault();\n          this.canvas.relativePan(new fabric.Point(0, 30 * this.canvas.getZoom()));\n        } else if (event.key == 'ArrowDown') {\n          event.preventDefault();\n          this.canvas.relativePan(new fabric.Point(0, -30 * this.canvas.getZoom()));\n        } else if (event.key == 'ArrowLeft') {\n          event.preventDefault();\n          this.canvas.relativePan(new fabric.Point(30 * this.canvas.getZoom(), 0));\n        } else if (event.key == 'ArrowRight') {\n          event.preventDefault();\n          this.canvas.relativePan(new fabric.Point(-30 * this.canvas.getZoom(), 0));\n        }\n      }\n    });\n    return () => {\n      if (document.removeAllListeners) document.removeAllListeners('keydown');\n    };\n  }\n  enablePanMode() {\n    this.mode = Mode.PAN;\n    this.lockPostsMovement(true);\n    this.canvas.defaultCursor = 'grab';\n    this.canvas.hoverCursor = 'grab';\n  }\n  enableEditMode() {\n    this.mode = Mode.EDIT;\n    this.lockPostsMovement(false);\n    this.canvas.defaultCursor = 'default';\n    this.canvas.hoverCursor = 'move';\n  }\n  handleZoom(event) {\n    const center = this.canvas.getCenter();\n    let centerX = center.left + (this.finalClientX - this.initialClientX);\n    let centerY = center.top + (this.finalClientY - this.initialClientY);\n    this.initialClientX = this.finalClientX;\n    this.initialClientY = this.finalClientY;\n    if (event === 'zoomIn') {\n      this.zoom += 0.05;\n    } else if (event === 'zoomOut') {\n      this.zoom -= 0.05;\n    } else if (event === 'reset') {\n      this.zoom = 1;\n    } else if (event === 'setZoom') {\n      // this.zoom = this.zoom;\n      centerX = center.left;\n      centerY = center.top;\n    }\n    if (this.zoom > 20) {\n      this.zoom = 20;\n    } else if (this.zoom < 0.01) {\n      this.zoom = 0.01;\n    }\n    this.canvas.zoomToPoint(new fabric.Point(centerX, centerY), this.zoom);\n  }\n  hideListsWhenModalOpen() {\n    const subscription = this.dialog.afterOpened.subscribe(() => {\n      this.showList = false;\n      this.showBuckets = false;\n    });\n    return () => {\n      subscription.unsubscribe();\n    };\n  }\n  lockArrowKeysWhenModalOpen() {\n    const subscription = this.dialog.afterOpened.subscribe(() => {\n      this.lockArrowKeys = true;\n    });\n    return () => {\n      subscription.unsubscribe();\n    };\n  }\n  unlockArrowKeysWhenModalClose() {\n    const subscription = this.dialog.afterAllClosed.subscribe(() => {\n      this.lockArrowKeys = false;\n    });\n    return () => {\n      subscription.unsubscribe();\n    };\n  }\n  openTodoList() {\n    this.router.navigate([`/project/${this.projectID}/todo`]);\n  }\n  copyEmbedCode() {\n    const url = window.location.href + '?embedded=true';\n    navigator.clipboard.writeText(url);\n  }\n  copyPersonalEmbedCode() {\n    const url = window.location.origin + `/project/${this.projectID}/my-personal-board?embedded=true`;\n    navigator.clipboard.writeText(url);\n  }\n  _openDialog(component, data, width = '700px') {\n    this.dialog.open(component, {\n      maxWidth: 1280,\n      width: width,\n      autoFocus: false,\n      data: data\n    });\n  }\n  _calcUpvoteCounter() {\n    this.upvotesService.getByBoardAndUser(this.boardID, this.user.userID).then(votes => {\n      this.upvoteCounter = this.board.upvoteLimit - votes.length;\n    });\n  }\n  _postsMovementAllowed() {\n    if (!this.user || !this.board) return false;\n    const isTeacher = this.user.role == Role.TEACHER;\n    const isStudent = this.user.role == Role.STUDENT;\n    const allowStudentMovement = this.board.permissions.allowStudentMoveAny;\n    return isTeacher || isStudent && allowStudentMovement;\n  }\n  _votingAllowed() {\n    const isStudent = this.user.role == Role.STUDENT;\n    const isTeacher = this.user.role == Role.TEACHER;\n    const allowStudent = isStudent && this.board.permissions.allowStudentUpvoting;\n    return allowStudent || isTeacher;\n  }\n  ngOnDestroy() {\n    var _this5 = this;\n    return _asyncToGenerator(function* () {\n      _this5.unsubListeners.forEach(s => s.unsubscribe());\n      _this5.socketService.disconnect(_this5.user.userID, _this5.boardID);\n      _this5.snackbarService.ngOnDestroy();\n    })();\n  }\n}\nCanvasComponent.ɵfac = function CanvasComponent_Factory(t) {\n  return new (t || CanvasComponent)(i0.ɵɵdirectiveInject(i1.PostService), i0.ɵɵdirectiveInject(i2.BoardService), i0.ɵɵdirectiveInject(i3.UserService), i0.ɵɵdirectiveInject(i4.CommentService), i0.ɵɵdirectiveInject(i5.UpvotesService), i0.ɵɵdirectiveInject(i6.ProjectService), i0.ɵɵdirectiveInject(i7.FabricUtils), i0.ɵɵdirectiveInject(i8.Router), i0.ɵɵdirectiveInject(i8.ActivatedRoute), i0.ɵɵdirectiveInject(i9.SnackbarService), i0.ɵɵdirectiveInject(i10.MatDialog), i0.ɵɵdirectiveInject(i11.FileUploadService), i0.ɵɵdirectiveInject(i12.SocketService), i0.ɵɵdirectiveInject(i13.CanvasService), i0.ɵɵdirectiveInject(i14.TraceService));\n};\nCanvasComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n  type: CanvasComponent,\n  selectors: [[\"app-canvas\"]],\n  hostBindings: function CanvasComponent_HostBindings(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵlistener(\"wheel\", function CanvasComponent_wheel_HostBindingHandler($event) {\n        return ctx.onMouseWheel($event);\n      });\n    }\n  },\n  decls: 28,\n  vars: 9,\n  consts: [[3, \"user\", 4, \"ngIf\"], [1, \"canvas-area\"], [\"id\", \"canvas\", 3, \"resize\"], [\"class\", \"top-embedded-board-name\", 4, \"ngIf\"], [\"class\", \"top-nav\", 4, \"ngIf\"], [1, \"bottom-nav\"], [1, \"toolSection\"], [1, \"toolField\"], [\"mat-fab\", \"\", \"color\", \"accent\", \"matTooltip\", \"Add Post\", \"matTooltipPosition\", \"before\", 3, \"disabled\", \"click\", 4, \"ngIf\"], [\"mat-fab\", \"\", \"color\", \"accent\", \"matTooltip\", \"Cancel Post\", \"matTooltipPosition\", \"before\", 3, \"click\", 4, \"ngIf\"], [\"mat-fab\", \"\", \"color\", \"accent\", \"matTooltip\", \"Switch to Move Posts Mode\", \"matTooltipPosition\", \"before\", 3, \"click\", 4, \"ngIf\"], [\"mat-fab\", \"\", \"color\", \"accent\", \"matTooltip\", \"Switch to Pan Mode (Right-click/Ctrl+click)\", \"matTooltipPosition\", \"before\", 3, \"click\", 4, \"ngIf\"], [1, \"zoomField\"], [\"mat-icon-button\", \"\", \"aria-label\", \"Zoom out\", 1, \"zoomButton\", 3, \"click\"], [\"aria-label\", \"Current zoom level\"], [\"mat-icon-button\", \"\", \"aria-label\", \"Zoom in\", 1, \"zoomButton\", 3, \"click\"], [\"mat-icon-button\", \"\", \"aria-label\", \"Reset zoom\", 1, \"zoomButton\", 3, \"click\"], [3, \"user\"], [\"class\", \"toolbarTitle\", 4, \"ngIf\"], [\"mat-icon-button\", \"\", \"matTooltip\", \"Read Task\", 3, \"click\"], [\"mat-icon-button\", \"\", \"matTooltip\", \"Copy embeddable URL\", 3, \"click\", 4, \"ngIf\"], [2, \"flex\", \"1 1 auto\"], [3, \"boardID\", \"currentView\"], [4, \"ngIf\"], [\"navbarMenu\", \"\", 3, \"board\", \"project\"], [1, \"toolbarTitle\"], [\"mat-icon-button\", \"\", \"matTooltip\", \"Copy embeddable URL\", 3, \"click\"], [3, \"user\", \"board\"], [1, \"top-embedded-board-name\"], [1, \"top-nav\"], [3, \"routerLink\"], [\"mat-fab\", \"\", \"color\", \"accent\", \"matTooltip\", \"Add Post\", \"matTooltipPosition\", \"before\", 3, \"disabled\", \"click\"], [\"mat-fab\", \"\", \"color\", \"accent\", \"matTooltip\", \"Cancel Post\", \"matTooltipPosition\", \"before\", 3, \"click\"], [\"mat-fab\", \"\", \"color\", \"accent\", \"matTooltip\", \"Switch to Move Posts Mode\", \"matTooltipPosition\", \"before\", 3, \"click\"], [1, \"material-symbols-outlined\", 2, \"padding-left\", \"1px\"], [\"mat-fab\", \"\", \"color\", \"accent\", \"matTooltip\", \"Switch to Pan Mode (Right-click/Ctrl+click)\", \"matTooltipPosition\", \"before\", 3, \"click\"], [2, \"padding-right\", \"3px\"]],\n  template: function CanvasComponent_Template(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵelementStart(0, \"div\")(1, \"div\");\n      i0.ɵɵtemplate(2, CanvasComponent_app_toolbar_2_Template, 10, 8, \"app-toolbar\", 0);\n      i0.ɵɵelementStart(3, \"div\", 1)(4, \"canvas\", 2);\n      i0.ɵɵlistener(\"resize\", function CanvasComponent_Template_canvas_resize_4_listener($event) {\n        return ctx.onResize($event);\n      }, false, i0.ɵɵresolveWindow);\n      i0.ɵɵelementEnd();\n      i0.ɵɵtemplate(5, CanvasComponent_div_5_Template, 2, 1, \"div\", 3);\n      i0.ɵɵtemplate(6, CanvasComponent_div_6_Template, 3, 1, \"div\", 4);\n      i0.ɵɵelementStart(7, \"div\", 5)(8, \"a\");\n      i0.ɵɵtext(9);\n      i0.ɵɵelementEnd()();\n      i0.ɵɵelementStart(10, \"div\", 6)(11, \"div\", 7);\n      i0.ɵɵtemplate(12, CanvasComponent_button_12_Template, 3, 1, \"button\", 8);\n      i0.ɵɵtemplate(13, CanvasComponent_button_13_Template, 3, 0, \"button\", 9);\n      i0.ɵɵtemplate(14, CanvasComponent_button_14_Template, 3, 0, \"button\", 10);\n      i0.ɵɵtemplate(15, CanvasComponent_button_15_Template, 3, 0, \"button\", 11);\n      i0.ɵɵelementEnd()();\n      i0.ɵɵelementStart(16, \"div\", 12)(17, \"button\", 13);\n      i0.ɵɵlistener(\"click\", function CanvasComponent_Template_button_click_17_listener() {\n        return ctx.handleZoom(\"zoomOut\");\n      });\n      i0.ɵɵelementStart(18, \"mat-icon\");\n      i0.ɵɵtext(19, \"remove\");\n      i0.ɵɵelementEnd()();\n      i0.ɵɵelementStart(20, \"span\", 14);\n      i0.ɵɵtext(21);\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementStart(22, \"button\", 15);\n      i0.ɵɵlistener(\"click\", function CanvasComponent_Template_button_click_22_listener() {\n        return ctx.handleZoom(\"zoomIn\");\n      });\n      i0.ɵɵelementStart(23, \"mat-icon\");\n      i0.ɵɵtext(24, \"add\");\n      i0.ɵɵelementEnd()();\n      i0.ɵɵelementStart(25, \"button\", 16);\n      i0.ɵɵlistener(\"click\", function CanvasComponent_Template_button_click_25_listener() {\n        return ctx.handleZoom(\"reset\");\n      });\n      i0.ɵɵelementStart(26, \"mat-icon\");\n      i0.ɵɵtext(27, \"refresh\");\n      i0.ɵɵelementEnd()()()()()();\n    }\n    if (rf & 2) {\n      i0.ɵɵadvance(2);\n      i0.ɵɵproperty(\"ngIf\", ctx.user && ctx.board && !ctx.embedded);\n      i0.ɵɵadvance(3);\n      i0.ɵɵproperty(\"ngIf\", ctx.user && ctx.board && ctx.embedded);\n      i0.ɵɵadvance(1);\n      i0.ɵɵproperty(\"ngIf\", !ctx.embedded);\n      i0.ɵɵadvance(3);\n      i0.ɵɵtextInterpolate1(\"\", ctx.upvoteCounter, \" upvotes remaining!\");\n      i0.ɵɵadvance(3);\n      i0.ɵɵproperty(\"ngIf\", ctx.mode !== ctx.modeType.CHOOSING_LOCATION);\n      i0.ɵɵadvance(1);\n      i0.ɵɵproperty(\"ngIf\", ctx.mode === ctx.modeType.CHOOSING_LOCATION);\n      i0.ɵɵadvance(1);\n      i0.ɵɵproperty(\"ngIf\", ctx.mode === ctx.modeType.EDIT);\n      i0.ɵɵadvance(1);\n      i0.ɵɵproperty(\"ngIf\", ctx.mode === ctx.modeType.PAN);\n      i0.ɵɵadvance(6);\n      i0.ɵɵtextInterpolate1(\"\", ctx.Math.round(ctx.zoom * 100), \"%\");\n    }\n  },\n  styles: [\"var[_ngcontent-%COMP%]   resource[_ngcontent-%COMP%];\\n (()[_ngcontent-%COMP%]   =[_ngcontent-%COMP%] >  { // webpackBootstrap\\n \\tvar __webpack_modules__ = ({\\n\\n 552:\\n\\n (() => {\\n\\nthrow new Error(\\\"Module build failed (from ./node_modules/sass-loader/dist/cjs.js):\\\\nSassError: Only 0 arguments allowed, but 1 was passed.\\\\n  \\u250C\\u2500\\u2500> src/styles.scss\\\\n12\\u2502 @include mat.core($custom-typography);\\\\n  \\u2502 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ invocation\\\\n  \\u2575\\\\n  \\u250C\\u2500\\u2500> node_modules/@angular/material/core/_core.scss\\\\n8 \\u2502 @mixin core() {\\\\n  \\u2502        \\u2501\\u2501\\u2501\\u2501\\u2501\\u2501 declaration\\\\n  \\u2575\\\\n  src/styles.scss 12:1                                 core()\\\\n  src/styles.scss 12:1                                 @import\\\\n  src/app/components/canvas/canvas.component.scss 1:9  root stylesheet\\\");\\n\\n })\\n\\n \\t});\\n\\n \\t\\n \\t// startup\\n \\t// Load entry module and return exports\\n \\t// This entry module doesn't tell about it's top-level declarations so it can't be inlined\\n \\tvar __webpack_exports__ = {};\\n \\t__webpack_modules__[552]();\\n \\tresource = __webpack_exports__;\\n \\t\\n })()\\n;\"]\n});","map":{"version":3,"mappings":"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","names":["fabric","PostType","PostModalComponent","AddPostComponent","Mode","POST_DEFAULT_OPACITY","POST_MOVING_FILL","POST_MOVING_OPACITY","SocketEvent","STUDENT_POST_COLOR","BoardScope","ViewType","Role","BucketsModalComponent","ListModalComponent","TaskModalComponent","getErrorMessage","FabricPostComponent","i0","ctx_r10","CanvasComponent","onMouseWheel","e","preventDefault","stopPropagation","constructor","postService","boardService","userService","commentService","upvotesService","projectService","fabricUtils","router","activatedRoute","snackbarService","dialog","fileUploadService","socketService","canvasService","traceService","Math","EDIT","CANVAS","post","type","BOARD","fabricPost","canvas","add","existing","getObjectFromId","postID","updatePostTitleDesc","title","desc","requestRenderAll","id","obj","remove","_calcUpvoteCounter","data","forEach","handlePostDeleteEvent","setFillColor","setOpacity","setPostMovement","displayAttributes","position","left","top","animateToPosition","fill","defaultPostColor","userID","_postsMovementAllowed","setCoords","renderAll","result","upvote","voterID","user","upvoteCounter","setUpvoteCount","amount","comment","setCommentCount","tag","applyTagFeatures","specialAttributes","resetTagFeatures","board","setBackgroundImage","bgImage","url","imgSettings","updateShowAddPost","permissions","lockPostsMovement","allowStudentMoveAny","role","STUDENT","setAuthorVisibilityAll","setTraceContext","projectID","boardID","resetedPosts","upvotes","includes","push","ids","TEACHER","navigate","state","code","message","postData","scope","PROJECT_PERSONAL","opt","target","selection","_openDialog","spawnPosition","absolutePointer","y","x","dequeueSnackbar","off","handleChoosePostLocation","enableEditMode","upvoteButton","subTargets","find","o","name","_votingAllowed","catch","queueSnackbar","unupvote","groupEventToHandler","Map","POST_CREATE","handlePostCreateEvent","POST_UPDATE","handlePostUpdateEvent","POST_DELETE","POST_START_MOVE","handlePostStartMoveEvent","POST_STOP_MOVE","handlePostStopMoveEvent","POST_UPVOTE_ADD","handlePostUpvoteAddEvent","POST_UPVOTE_REMOVE","handlePostUpvoteRemoveEvent","POST_COMMENT_ADD","handlePostCommentAddEvent","POST_COMMENT_REMOVE","handlePostCommentRemoveEvent","POST_TAG_ADD","handlePostTagAddEvent","POST_TAG_REMOVE","handlePostTagRemoveEvent","BOARD_NAME_UPDATE","handleBoardNameUpdateEvent","BOARD_IMAGE_UPDATE","handleBoardImageUpdateEvent","BOARD_PERMISSIONS_UPDATE","handleBoardPermsUpdateEvent","BOARD_TAGS_UPDATE","handleBoardTagsUpdateEvent","BOARD_TASK_UPDATE","handleBoardTaskUpdateEvent","BOARD_UPVOTE_UPDATE","handleBoardUpvoteUpdateEvent","VOTES_CLEAR","handleVotesClearEvent","BOARD_CLEAR","handleBoardClearEvent","WORKFLOW_RUN_DISTRIBUTION","handleWorkflowRun","WORKFLOW_POST_SUBMIT","handleWorkflowPost","BOARD_CONN_UPDATE","handleBoardConnEvent","ngOnInit","queryParams","subscribe","params","embedded","Canvas","embeddedCanvasConfig","canvasConfig","_canvas","configureBoard","connect","initCanvasEventsListener","initGroupEventsListener","window","onbeforeunload","ngOnDestroy","unsubCtrl","initCtrlKeyListener","unsubMoving","initMovingPostListener","unsubExpand","initPostClickListener","unsubUpvote","initUpvoteClickListener","unsubZoom","initZoomListener","unsubPan","initPanListener","unsubSwipePan","initPanSwipeListener","unsubKeyPan","initKeyPanningListener","unsubModal","hideListsWhenModalOpen","unsubArrowKeyLock","lockArrowKeysWhenModalOpen","unsubArrowKeyUnlock","unlockArrowKeysWhenModalClose","k","v","unsub","listen","unsubListeners","showBucketsModal","centerX","getCenter","centerY","showListModal","intermediateBoardConfig","configureZoom","showSnackBarStudent","openTaskDialog","map","snapshot","paramMap","has","get","getAllByBoard","then","getUpvotesByPost","comments","getCommentsByPost","length","viewSettings","allowCanvas","navigateByUrl","defaultView","toLowerCase","personalBoard","getPersonal","project","initialZoom","zoom","parseFloat","toPrecision","handleZoom","handleCreatePost","mode","CHOOSING_LOCATION","defaultCursor","hoverCursor","on","disableChooseLocation","value","getObjects","set","lockMovementX","lockMovementY","onResize","event","scaleX","innerWidth","getWidth","scaleY","innerHeight","getHeight","objects","i","getObjectScaling","setWidth","setHeight","calcOffset","hideAuthorNames","updateAuthor","updateAuthorNames","username","setAuthorVisibilityOne","isStudentAndVisible","showAuthorNameStudent","IsTeacherAndVisisble","showAuthorNameTeacher","console","log","getOneById","isStudent","isTeacher","showAddPost","allowStudentEditAddDeletePost","task","snackbarIsOpen","openDialogCloseSnack","action","run","matSnackbarConfig","verticalPosition","horizontalPosition","panelClass","handleUpvoteClick","handleDownvoteClick","document","addEventListener","rightClickDown","key","ctrlPressed","prevMode","enablePanMode","removeAllListeners","isDragging","isMouseDown","postClickHandler","postMovingHandler","mouseUpHandler","votePress","commentPress","isDragEnd","discardActiveObject","numSavedPosts","updateNumSavedPosts","num","readPost","isMovingPost","handleFirstMove","emit","handleDroppedPost","handleZoomEvent","options","trackpad_pinch","Number","isInteger","deltaY","abs","deltaX","ctrlKey","mousewheel","floor","delta","zoomToPoint","Point","offsetX","offsetY","isPanning","mouseDown","button","which","PAN","initialClientX","clientX","initialClientY","clientY","mouseUp","handlePan","movementX","movementY","relativePan","finalClientX","finalClientY","handlePanSwipe","trackpad_twofinger","vpt","viewportTransform","setViewportTransform","lockArrowKeys","getZoom","center","subscription","afterOpened","showList","showBuckets","unsubscribe","afterAllClosed","openTodoList","copyEmbedCode","location","href","navigator","clipboard","writeText","copyPersonalEmbedCode","origin","component","width","open","maxWidth","autoFocus","getByBoardAndUser","votes","upvoteLimit","allowStudentMovement","allowStudent","allowStudentUpvoting","s","disconnect","selectors","hostBindings","ctx"],"sourceRoot":"","sources":["/Users/marieklinaeva/github/ck-board/frontend/src/app/components/canvas/canvas.component.ts","/Users/marieklinaeva/github/ck-board/frontend/src/app/components/canvas/canvas.component.html"],"sourcesContent":["import { Component, OnDestroy, OnInit, HostListener } from '@angular/core';\nimport { fabric } from 'fabric';\nimport { Canvas } from 'fabric/fabric-impl';\n\nimport { MatDialog } from '@angular/material/dialog';\n\nimport Post, { PostType } from '../../models/post';\n\nimport { BoardService } from '../../services/board.service';\nimport { PostService } from '../../services/post.service';\n\nimport { PostModalComponent } from '../post-modal/post-modal.component';\nimport { AddPostComponent } from '../add-post-modal/add-post.component';\nimport { FabricUtils } from 'src/app/utils/FabricUtils';\nimport {\n  Mode,\n  POST_DEFAULT_OPACITY,\n  POST_MOVING_FILL,\n  POST_MOVING_OPACITY,\n  SocketEvent,\n  STUDENT_POST_COLOR,\n} from 'src/app/utils/constants';\nimport { UserService } from 'src/app/services/user.service';\nimport {\n  Board,\n  BoardPermissions,\n  BoardScope,\n  ViewType,\n} from 'src/app/models/board';\nimport { AuthUser, Role } from 'src/app/models/user';\nimport { ActivatedRoute, Router } from '@angular/router';\nimport { CommentService } from 'src/app/services/comment.service';\nimport { UpvotesService } from 'src/app/services/upvotes.service';\nimport { CreateWorkflowModalComponent } from '../create-workflow-modal/create-workflow-modal.component';\nimport { BucketsModalComponent } from '../buckets-modal/buckets-modal.component';\nimport { ListModalComponent } from '../list-modal/list-modal.component';\nimport { FileUploadService } from 'src/app/services/fileUpload.service';\nimport { SnackbarService } from 'src/app/services/snackbar.service';\nimport { TaskModalComponent } from '../task-modal/task-modal.component';\nimport { Project } from 'src/app/models/project';\nimport { ProjectService } from 'src/app/services/project.service';\nimport { SocketService } from 'src/app/services/socket.service';\nimport { CanvasService } from 'src/app/services/canvas.service';\nimport { ComponentType } from '@angular/cdk/portal';\nimport { getErrorMessage } from 'src/app/utils/Utils';\nimport { Subscription } from 'rxjs';\nimport { FabricPostComponent } from '../fabric-post/fabric-post.component';\nimport { TraceService } from 'src/app/services/trace.service';\nimport Upvote from 'src/app/models/upvote';\nimport { ManageGroupModalComponent } from '../groups/manage-group-modal/manage-group-modal.component';\nimport { TodoListModalComponent } from '../todo-list-modal/todo-list-modal.component';\nimport { ProjectTodoListModalComponent } from '../project-todo-list-modal/project-todo-list-modal.component';\n\n@Component({\n  selector: 'app-canvas',\n  templateUrl: './canvas.component.html',\n  styleUrls: ['./canvas.component.scss'],\n})\nexport class CanvasComponent implements OnInit, OnDestroy {\n  boardID: string;\n  projectID: string;\n  canvas: Canvas;\n\n  user: AuthUser;\n  board: Board;\n  project: Project;\n\n  groupEventToHandler: Map<SocketEvent, Function>;\n\n  Math: Math = Math;\n  initialClientX = 0;\n  initialClientY = 0;\n  finalClientX = 0;\n  finalClientY = 0;\n\n  embedded = false;\n\n  numSavedPosts: number = 0;\n\n  zoom = 1;\n\n  ctrlPressed = false;\n  rightClickDown = false;\n\n  mode: Mode = Mode.EDIT;\n  prevMode: Mode = Mode.EDIT;\n  modeType = Mode;\n  Role: typeof Role = Role;\n  BoardScope: typeof BoardScope = BoardScope;\n\n  showList = false;\n  showBuckets = false;\n\n  showAddPost = true;\n  lockArrowKeys = false;\n\n  upvoteCounter = 0;\n\n  unsubListeners: Subscription[] = [];\n\n  viewType = ViewType.CANVAS;\n\n  @HostListener('wheel', ['$event'])\n  onMouseWheel(e: WheelEvent) {\n    e.preventDefault();\n    e.stopPropagation();\n  }\n\n  constructor(\n    public postService: PostService,\n    public boardService: BoardService,\n    public userService: UserService,\n    public commentService: CommentService,\n    public upvotesService: UpvotesService,\n    public projectService: ProjectService,\n    protected fabricUtils: FabricUtils,\n    private router: Router,\n    private activatedRoute: ActivatedRoute,\n    public snackbarService: SnackbarService,\n    public dialog: MatDialog,\n    public fileUploadService: FileUploadService,\n    private socketService: SocketService,\n    private canvasService: CanvasService,\n    private traceService: TraceService\n  ) {\n    this.groupEventToHandler = new Map<SocketEvent, Function>([\n      [SocketEvent.POST_CREATE, this.handlePostCreateEvent],\n      [SocketEvent.POST_UPDATE, this.handlePostUpdateEvent],\n      [SocketEvent.POST_DELETE, this.handlePostDeleteEvent],\n      [SocketEvent.POST_START_MOVE, this.handlePostStartMoveEvent],\n      [SocketEvent.POST_STOP_MOVE, this.handlePostStopMoveEvent],\n      [SocketEvent.POST_UPVOTE_ADD, this.handlePostUpvoteAddEvent],\n      [SocketEvent.POST_UPVOTE_REMOVE, this.handlePostUpvoteRemoveEvent],\n      [SocketEvent.POST_COMMENT_ADD, this.handlePostCommentAddEvent],\n      [SocketEvent.POST_COMMENT_REMOVE, this.handlePostCommentRemoveEvent],\n      [SocketEvent.POST_TAG_ADD, this.handlePostTagAddEvent],\n      [SocketEvent.POST_TAG_REMOVE, this.handlePostTagRemoveEvent],\n      [SocketEvent.BOARD_NAME_UPDATE, this.handleBoardNameUpdateEvent],\n      [SocketEvent.BOARD_IMAGE_UPDATE, this.handleBoardImageUpdateEvent],\n      [SocketEvent.BOARD_PERMISSIONS_UPDATE, this.handleBoardPermsUpdateEvent],\n      [SocketEvent.BOARD_TAGS_UPDATE, this.handleBoardTagsUpdateEvent],\n      [SocketEvent.BOARD_TASK_UPDATE, this.handleBoardTaskUpdateEvent],\n      [SocketEvent.BOARD_UPVOTE_UPDATE, this.handleBoardUpvoteUpdateEvent],\n      [SocketEvent.VOTES_CLEAR, this.handleVotesClearEvent],\n      [SocketEvent.BOARD_CLEAR, this.handleBoardClearEvent],\n      [SocketEvent.WORKFLOW_RUN_DISTRIBUTION, this.handleWorkflowRun],\n      [SocketEvent.WORKFLOW_POST_SUBMIT, this.handleWorkflowPost],\n      [SocketEvent.BOARD_CONN_UPDATE, this.handleBoardConnEvent],\n    ]);\n  }\n\n  async ngOnInit() {\n    this.activatedRoute.queryParams.subscribe((params) => {\n      if (params.embedded == 'true') {\n        this.embedded = true;\n      }\n    });\n\n    this.user = this.userService.user!;\n    this.canvas = new fabric.Canvas(\n      'canvas',\n      this.embedded\n        ? this.fabricUtils.embeddedCanvasConfig\n        : this.fabricUtils.canvasConfig\n    );\n    this.fabricUtils._canvas = this.canvas;\n\n    await this.configureBoard();\n    this.socketService.connect(this.user.userID, this.boardID);\n\n    this.initCanvasEventsListener();\n    this.initGroupEventsListener();\n\n    window.onbeforeunload = () => this.ngOnDestroy();\n  }\n\n  initCanvasEventsListener() {\n    const unsubCtrl = this.initCtrlKeyListener();\n    const unsubMoving = this.initMovingPostListener();\n    const unsubExpand = this.initPostClickListener();\n    const unsubUpvote = this.initUpvoteClickListener();\n    const unsubZoom = this.initZoomListener();\n    const unsubPan = this.initPanListener();\n    const unsubSwipePan = this.initPanSwipeListener();\n    const unsubKeyPan = this.initKeyPanningListener();\n    const unsubModal = this.hideListsWhenModalOpen();\n    const unsubArrowKeyLock = this.lockArrowKeysWhenModalOpen();\n    const unsubArrowKeyUnlock = this.unlockArrowKeysWhenModalClose();\n\n    return [\n      unsubCtrl,\n      unsubUpvote,\n      unsubExpand,\n      unsubModal,\n      unsubMoving,\n      unsubZoom,\n      unsubPan,\n      unsubSwipePan,\n      unsubKeyPan,\n      unsubArrowKeyLock,\n      unsubArrowKeyUnlock,\n    ];\n  }\n\n  initGroupEventsListener() {\n    for (const [k, v] of this.groupEventToHandler) {\n      const unsub = this.socketService.listen(k, v);\n      this.unsubListeners.push(unsub);\n    }\n  }\n\n  handlePostCreateEvent = (post: Post) => {\n    if (post.type === PostType.BOARD) {\n      const fabricPost = new FabricPostComponent(post);\n      this.canvas.add(fabricPost);\n    }\n  };\n\n  handlePostUpdateEvent = (post: Post) => {\n    let existing = this.fabricUtils.getObjectFromId(post.postID);\n\n    if (existing) {\n      existing = this.fabricUtils.updatePostTitleDesc(\n        existing,\n        post.title,\n        post.desc\n      );\n      this.canvas.requestRenderAll();\n    }\n  };\n\n  handlePostDeleteEvent = (id: string) => {\n    const obj = this.fabricUtils.getObjectFromId(id);\n    if (obj) {\n      this.canvas.remove(obj);\n    }\n\n    this._calcUpvoteCounter();\n  };\n\n  handleWorkflowRun = (data: string[] | null) => {\n    if (data) {\n      data.forEach((postID) => this.handlePostDeleteEvent(postID));\n    }\n  };\n\n  handleWorkflowPost = (postID: string): void => {\n    this.handlePostDeleteEvent(postID);\n  };\n\n  handlePostStartMoveEvent = (post: Post) => {\n    let obj = this.fabricUtils.getObjectFromId(post.postID);\n    obj = this.fabricUtils.setFillColor(obj, POST_MOVING_FILL);\n    obj = this.fabricUtils.setOpacity(obj, POST_MOVING_OPACITY);\n    obj = this.fabricUtils.setPostMovement(obj, true);\n    this.canvas.requestRenderAll();\n  };\n\n  handlePostStopMoveEvent = (post: Post) => {\n    if (!post.displayAttributes?.position) return;\n\n    let existing = this.fabricUtils.getObjectFromId(post.postID);\n\n    const { left, top } = post.displayAttributes.position;\n\n    this.fabricUtils.animateToPosition(existing, left, top, async () => {\n      const fill = await this.fabricUtils.defaultPostColor(post.userID);\n      existing = this.fabricUtils.setFillColor(\n        existing,\n        fill ?? STUDENT_POST_COLOR\n      );\n      existing = this.fabricUtils.setOpacity(existing, POST_DEFAULT_OPACITY);\n      existing = this.fabricUtils.setPostMovement(\n        existing,\n        !this._postsMovementAllowed()\n      );\n      existing.setCoords();\n      this.canvas.renderAll();\n    });\n  };\n\n  handlePostUpvoteAddEvent = (result: any) => {\n    if (result.upvote.voterID == this.user.userID) this.upvoteCounter -= 1;\n\n    let existing = this.fabricUtils.getObjectFromId(result.upvote.postID);\n    if (existing) {\n      existing = this.fabricUtils.setUpvoteCount(existing, result.amount);\n      this.canvas.requestRenderAll();\n    }\n  };\n\n  handlePostUpvoteRemoveEvent = (result: any) => {\n    if (result.upvote.voterID == this.user.userID) this.upvoteCounter += 1;\n\n    let existing = this.fabricUtils.getObjectFromId(result.upvote.postID);\n    if (existing) {\n      existing = this.fabricUtils.setUpvoteCount(existing, result.amount);\n      this.canvas.requestRenderAll();\n    }\n  };\n\n  handlePostCommentAddEvent = (result: any) => {\n    let existing = this.fabricUtils.getObjectFromId(result.comment.postID);\n    if (existing) {\n      existing = this.fabricUtils.setCommentCount(existing, result.amount);\n      this.canvas.requestRenderAll();\n    }\n  };\n\n  handlePostCommentRemoveEvent = (result: any) => {\n    let existing = this.fabricUtils.getObjectFromId(result.comment.postID);\n    if (existing) {\n      existing = this.fabricUtils.setCommentCount(existing, result.amount);\n      this.canvas.requestRenderAll();\n    }\n  };\n\n  handlePostTagAddEvent = ({ post, tag }) => {\n    const existing = this.fabricUtils.getObjectFromId(post.postID);\n    if (existing) {\n      this.fabricUtils.applyTagFeatures(existing, tag);\n    }\n  };\n\n  handlePostTagRemoveEvent = ({ post, tag }) => {\n    const existing = this.fabricUtils.getObjectFromId(post.postID);\n    if (post.specialAttributes && existing) {\n      this.fabricUtils.resetTagFeatures(existing);\n    }\n  };\n\n  handleBoardNameUpdateEvent = (board: Board) => {\n    this.board = board;\n  };\n\n  handleBoardImageUpdateEvent = (board: Board) => {\n    this.board = board;\n    this.fabricUtils.setBackgroundImage(\n      board.bgImage?.url,\n      board.bgImage?.imgSettings\n    );\n  };\n\n  handleBoardPermsUpdateEvent = (board: Board) => {\n    this.board = board;\n    this.updateShowAddPost(board.permissions);\n    this.lockPostsMovement(\n      !board.permissions.allowStudentMoveAny && this.user.role == Role.STUDENT\n    );\n    this.setAuthorVisibilityAll();\n    this.traceService.setTraceContext(this.projectID, this.boardID);\n  };\n\n  handleBoardTagsUpdateEvent = (board: Board) => {\n    this.board = board;\n  };\n\n  handleBoardTaskUpdateEvent = (board: Board) => {\n    this.board = board;\n  };\n\n  handleBoardUpvoteUpdateEvent = (board: Board) => {\n    this.board = board;\n    this._calcUpvoteCounter();\n  };\n\n  handleVotesClearEvent = async (result: Upvote[]) => {\n    this._calcUpvoteCounter();\n    const resetedPosts: string[] = [];\n    for (const upvotes of result) {\n      if (!resetedPosts.includes(upvotes.postID)) {\n        let existing = this.fabricUtils.getObjectFromId(upvotes.postID);\n        if (existing) {\n          existing = this.fabricUtils.setUpvoteCount(existing, 0);\n          this.canvas.requestRenderAll();\n          resetedPosts.push(upvotes.postID);\n        }\n      }\n    }\n  };\n\n  handleBoardClearEvent = (ids: string[]) => {\n    ids.forEach((id) => {\n      this.handlePostDeleteEvent(id);\n    });\n  };\n\n  handleBoardConnEvent = () => {\n    if (this.user.role === Role.TEACHER) return;\n    this.router.navigate(['/error'], {\n      state: {\n        code: 403,\n        message: 'You do not have access to this board!',\n      },\n    });\n  };\n\n  handlePersonalBoardAddPost = (postData: any) => {\n    if (\n      postData.post.type === PostType.BOARD &&\n      this.board.scope === BoardScope.PROJECT_PERSONAL\n    ) {\n      const fabricPost = new FabricPostComponent(postData.post);\n      this.canvas.add(fabricPost);\n    }\n  };\n  showBucketsModal() {\n    this._openDialog(\n      BucketsModalComponent,\n      {\n        board: this.board,\n        user: this.user,\n        centerX: this.canvas.getCenter().left,\n        centerY: this.canvas.getCenter().top,\n      },\n      '95vw'\n    );\n  }\n\n  showListModal() {\n    this._openDialog(\n      ListModalComponent,\n      {\n        board: this.board,\n        user: this.user,\n        centerX: this.canvas.getCenter().left,\n        centerY: this.canvas.getCenter().top,\n      },\n      '95vw'\n    );\n  }\n\n  intermediateBoardConfig(board: Board) {\n    this.board = board;\n    this._calcUpvoteCounter();\n    this.configureZoom();\n    this.fabricUtils.setBackgroundImage(\n      board.bgImage?.url,\n      board.bgImage?.imgSettings\n    );\n    this.lockPostsMovement(\n      !board.permissions.allowStudentMoveAny && this.user.role == Role.STUDENT\n    );\n    this.updateShowAddPost(this.board.permissions);\n    this.setAuthorVisibilityAll();\n    if (this.board.permissions.showSnackBarStudent) {\n      this.openTaskDialog();\n    }\n  }\n\n  async configureBoard() {\n    const map = this.activatedRoute.snapshot.paramMap;\n\n    if (map.has('boardID') && map.has('projectID')) {\n      this.boardID = this.activatedRoute.snapshot.paramMap.get('boardID') ?? '';\n      this.projectID =\n        this.activatedRoute.snapshot.paramMap.get('projectID') ?? '';\n      this.traceService.setTraceContext(this.projectID, this.boardID);\n      this.postService.getAllByBoard(this.boardID).then((data) => {\n        data.forEach(async (post) => {\n          if (post.type == PostType.BOARD) {\n            const upvotes = await this.upvotesService.getUpvotesByPost(\n              post.postID\n            );\n            const comments = await this.commentService.getCommentsByPost(\n              post.postID\n            );\n            this.canvas.add(\n              new FabricPostComponent(post, {\n                upvotes: upvotes.length,\n                comments: comments.length,\n              })\n            );\n          }\n        });\n        this.boardService.get(this.boardID).then((board) => {\n          if (board) this.intermediateBoardConfig(board);\n          if (this.board && !this.board.viewSettings?.allowCanvas) {\n            this.router.navigateByUrl(\n              `project/${this.projectID}/board/${\n                this.boardID\n              }/${this.board.defaultView?.toLowerCase()}`\n            );\n          }\n        });\n      });\n    } else if (map.has('projectID')) {\n      this.projectID =\n        this.activatedRoute.snapshot.paramMap.get('projectID') ?? '';\n      const personalBoard = await this.boardService.getPersonal(this.projectID);\n      if (personalBoard) {\n        this.boardID = personalBoard.boardID;\n        this.traceService.setTraceContext(this.projectID, this.boardID);\n      } else this.router.navigate(['error']);\n\n      this.postService.getAllByBoard(this.boardID).then((data) => {\n        data.forEach(async (post) => {\n          if (post.type == PostType.BOARD) {\n            const upvotes = await this.upvotesService.getUpvotesByPost(\n              post.postID\n            );\n            const comments = await this.commentService.getCommentsByPost(\n              post.postID\n            );\n            this.canvas.add(\n              new FabricPostComponent(post, {\n                upvotes: upvotes.length,\n                comments: comments.length,\n              })\n            );\n          }\n        });\n        if (personalBoard) this.intermediateBoardConfig(personalBoard);\n      });\n    } else {\n      this.router.navigate(['error']);\n    }\n    this.projectService\n      .get(this.projectID)\n      .then((project) => (this.project = project));\n  }\n\n  // TODO: handle board update from toolbar-menu\n  configureZoom() {\n    if (this.board.initialZoom) {\n      const zoom = this.board.initialZoom / 100;\n      this.zoom = parseFloat(zoom.toPrecision(2));\n      this.handleZoom('setZoom');\n    } else {\n      this.zoom = 1;\n    }\n  }\n\n  // open dialog to get message for a new post\n  handleCreatePost() {\n    this.mode = Mode.CHOOSING_LOCATION;\n    this.canvas.defaultCursor = 'copy';\n    this.canvas.hoverCursor = 'not-allowed';\n    this.snackbarService.queueSnackbar(\n      'Click where you want the post to be created!'\n    );\n    this.canvas.on('mouse:down', this.handleChoosePostLocation);\n  }\n\n  handleChoosePostLocation = (opt) => {\n    if (opt.target == null) {\n      this.canvas.selection = false;\n      this._openDialog(AddPostComponent, {\n        type: PostType.BOARD,\n        board: this.board,\n        user: this.user,\n        spawnPosition: {\n          top: opt.absolutePointer ? opt.absolutePointer.y : 150,\n          left: opt.absolutePointer ? opt.absolutePointer.x : 150,\n        },\n      });\n    }\n    this.snackbarService.dequeueSnackbar();\n    this.canvas.off('mouse:down', this.handleChoosePostLocation);\n    this.enableEditMode();\n  };\n\n  disableChooseLocation() {\n    this.snackbarService.dequeueSnackbar();\n    this.canvas.off('mouse:down', this.handleChoosePostLocation);\n    this.enableEditMode();\n  }\n\n  lockPostsMovement(value) {\n    this.canvas.getObjects().map((obj) => {\n      obj.set({ lockMovementX: value, lockMovementY: value });\n    });\n    this.canvas.renderAll();\n  }\n\n  onResize(event) {\n    const scaleX = event.target.innerWidth / this.canvas.getWidth();\n    // Without toolbar height\n    const scaleY = (event.target.innerHeight - 64) / this.canvas.getHeight();\n    const objects = this.canvas.getObjects();\n\n    // Resize all objects inside the canvas\n    for (const i in objects) {\n      objects[i].scaleX = objects[i].getObjectScaling().scaleX * scaleY;\n      objects[i].scaleY = objects[i].getObjectScaling().scaleY * scaleY;\n      objects[i].left = (objects[i].left || 0) * scaleX;\n      objects[i].top = (objects[i].top || 0) * scaleY;\n      objects[i].setCoords();\n    }\n\n    this.canvas.setWidth(event.target.innerWidth);\n    // Without toolbar height\n    this.canvas.setHeight(event.target.innerHeight - 64);\n\n    this.canvas.renderAll();\n    this.canvas.calcOffset();\n  }\n\n  hideAuthorNames() {\n    this.canvas.getObjects().map((obj) => {\n      this.fabricUtils.updateAuthor(obj, 'Anonymous');\n    });\n    this.canvas.renderAll();\n  }\n\n  updateAuthorNames(postID: string, username: string) {\n    const obj = this.fabricUtils.getObjectFromId(postID);\n    if (obj) {\n      this.fabricUtils.updateAuthor(obj, username);\n      this.canvas.renderAll();\n    }\n  }\n\n  setAuthorVisibilityOne(post) {\n    if (!this.board) {\n      return;\n    }\n    const isStudentAndVisible =\n      this.user.role == Role.STUDENT &&\n      this.board.permissions.showAuthorNameStudent;\n    const IsTeacherAndVisisble =\n      this.user.role == Role.TEACHER &&\n      this.board.permissions.showAuthorNameTeacher;\n    if (!(isStudentAndVisible || IsTeacherAndVisisble)) {\n      this.updateAuthorNames(post.postID, 'Anonymous');\n    } else {\n      console.log('can');\n      this.userService.getOneById(post.userID).then((user: any) => {\n        this.updateAuthorNames(post.postID, user.username);\n      });\n    }\n  }\n\n  setAuthorVisibilityAll() {\n    this.postService.getAllByBoard(this.boardID).then((data) => {\n      // update all the post names to to the poster's name rather than anonymous\n      data.forEach((post) => {\n        this.setAuthorVisibilityOne(post);\n      });\n    });\n  }\n\n  updateShowAddPost(permissions: BoardPermissions) {\n    const isStudent = this.user.role == Role.STUDENT;\n    const isTeacher = this.user.role == Role.TEACHER;\n    this.showAddPost =\n      (isStudent && permissions.allowStudentEditAddDeletePost) || isTeacher;\n  }\n\n  openTaskDialog() {\n    if (!this.board.task) return;\n\n    const title = this.board.task.title\n      ? this.board.task.title\n      : 'No task created!';\n    const message = this.board.task.message;\n\n    if (this.snackbarService.snackbarIsOpen()) {\n      this.snackbarService.dequeueSnackbar();\n      return;\n    }\n\n    const openDialogCloseSnack = () => {\n      this._openDialog(TaskModalComponent, {\n        title: title,\n        message: message,\n      });\n      this.snackbarService.dequeueSnackbar();\n    };\n\n    this.snackbarService.queueSnackbar(title, message, {\n      action: { name: 'View Full Task', run: openDialogCloseSnack },\n      matSnackbarConfig: {\n        verticalPosition: 'bottom',\n        horizontalPosition: 'center',\n        panelClass: ['wide-snackbar'],\n      },\n    });\n  }\n\n  initUpvoteClickListener() {\n    this.canvas.on('mouse:down', this.handleUpvoteClick);\n    this.canvas.on('mouse:down', this.handleDownvoteClick);\n\n    return () => {\n      this.canvas.off('mouse:down', this.handleUpvoteClick);\n      this.canvas.off('mouse:down', this.handleDownvoteClick);\n    };\n  }\n\n  handleUpvoteClick = async (e: fabric.IEvent) => {\n    const post: any = e.target;\n    const upvoteButton = e.subTargets?.find((o) => o.name == 'upvote');\n\n    if (upvoteButton && this._votingAllowed()) {\n      this.canvasService\n        .upvote(this.user.userID, post.postID)\n        .catch((e) => this.snackbarService.queueSnackbar(getErrorMessage(e)));\n    }\n  };\n\n  handleDownvoteClick = async (e: fabric.IEvent) => {\n    const post: any = e.target;\n    const upvoteButton = e.subTargets?.find((o) => o.name == 'downvote');\n\n    if (upvoteButton && this._votingAllowed()) {\n      this.canvasService\n        .unupvote(this.user.userID, post.postID)\n        .catch((e) => this.snackbarService.queueSnackbar(getErrorMessage(e)));\n    }\n  };\n\n  initCtrlKeyListener() {\n    document.addEventListener('keydown', (event) => {\n      /* Switch to pan mode on Ctrl press, only if not already holding right-click down */\n      if (!this.rightClickDown && event.key === 'Control') {\n        this.ctrlPressed = true;\n        this.prevMode = this.mode;\n        this.enablePanMode();\n      }\n    });\n\n    document.addEventListener('keyup', (event) => {\n      if (event.key === 'Control') {\n        this.ctrlPressed = false;\n        if (this.prevMode === Mode.EDIT) {\n          this.enableEditMode();\n        }\n      }\n    });\n\n    return () => {\n      if (document.removeAllListeners) {\n        document.removeAllListeners('keydown');\n        document.removeAllListeners('keyup');\n      }\n    };\n  }\n\n  initPostClickListener() {\n    let isDragging = false;\n    let isMouseDown = false;\n\n    const postClickHandler = (e: fabric.IEvent) => {\n      if (e.target?.name == 'post') isMouseDown = true;\n    };\n\n    const postMovingHandler = (e: fabric.IEvent) => {\n      if (e.target?.name == 'post') isDragging = isMouseDown;\n    };\n\n    const mouseUpHandler = (e: fabric.IEvent) => {\n      const obj: any = e.target;\n\n      const votePress = e.subTargets?.find(\n        (o) => o.name == 'upvote' || o.name == 'downvote'\n      );\n      const commentPress = e.subTargets?.find((o) => o.name == 'comment');\n      const isDragEnd = isDragging;\n      isDragging = false;\n      isMouseDown = false;\n\n      if (!isDragEnd && !votePress && obj?.name == 'post') {\n        this.canvas.discardActiveObject().renderAll();\n\n        this._openDialog(PostModalComponent, {\n          user: this.user,\n          post: obj,\n          board: this.board,\n          commentPress: commentPress,\n          numSavedPosts: this.numSavedPosts,\n          updateNumSavedPosts: (num) => {\n            this.numSavedPosts = num;\n          },\n        });\n        this.canvasService.readPost(obj.postID);\n      }\n    };\n\n    this.canvas.on('mouse:down', postClickHandler);\n    this.canvas.on('mouse:move', postMovingHandler);\n    this.canvas.on('mouse:up', mouseUpHandler);\n\n    return () => {\n      this.canvas.off('mouse:down', postClickHandler);\n      this.canvas.off('mouse:move', postMovingHandler);\n      this.canvas.off('mouse:up', mouseUpHandler);\n    };\n  }\n\n  initMovingPostListener() {\n    let isMovingPost = false;\n\n    const handleFirstMove = (e: any) => {\n      if (e.target && !isMovingPost) {\n        let obj = e.target;\n        isMovingPost = true;\n\n        obj = this.fabricUtils.setFillColor(obj, POST_MOVING_FILL);\n        obj = this.fabricUtils.setOpacity(obj, POST_MOVING_OPACITY);\n        this.canvas.renderAll();\n\n        this.socketService.emit(SocketEvent.POST_START_MOVE, {\n          postID: obj.postID,\n        });\n      }\n    };\n\n    const handleDroppedPost = async (e) => {\n      if (!isMovingPost) return;\n\n      let obj = e.target;\n      isMovingPost = false;\n\n      const fill = await this.fabricUtils.defaultPostColor(obj.userID);\n      obj = this.fabricUtils.setFillColor(obj, fill ?? STUDENT_POST_COLOR);\n      obj = this.fabricUtils.setOpacity(obj, POST_DEFAULT_OPACITY);\n      this.canvas.renderAll();\n\n      this.socketService.emit(SocketEvent.POST_STOP_MOVE, {\n        postID: obj.postID,\n        left: obj.left,\n        top: obj.top,\n      });\n    };\n\n    this.canvas.on('object:moving', handleFirstMove);\n    this.canvas.on('mouse:up', handleDroppedPost);\n\n    return () => {\n      this.canvas.off('object:moving', handleFirstMove);\n      this.canvas.off('mouse:up', handleDroppedPost);\n    };\n  }\n\n  initZoomListener() {\n    const handleZoomEvent = (opt) => {\n      const options = opt.e as unknown as WheelEvent;\n\n      // Condition for pinch gesture on trackpad:\n      // 1. delta Y is an integer or delta X is 0\n      // 2. ctrl key is triggered\n      const trackpad_pinch =\n        (Number.isInteger(options.deltaY) || Math.abs(options.deltaX) < 1e-9) &&\n        options.ctrlKey;\n\n      // Condition for mousewheel:\n      // 1. delta Y has trailing non-zero decimal points\n      // 2. delta X is zero\n      // 3. ctrl key is not triggered\n      const mousewheel =\n        !(Math.abs(options.deltaY - Math.floor(options.deltaY)) < 1e-9) &&\n        Math.abs(options.deltaX) < 1e-9 &&\n        !options.ctrlKey;\n\n      if (trackpad_pinch || mousewheel) {\n        const delta = options.deltaY;\n\n        if (mousewheel) {\n          this.zoom *= 0.999 ** delta;\n        } else {\n          this.zoom *= 0.99 ** delta;\n        }\n        if (this.zoom > 20) this.zoom = 20;\n        if (this.zoom < 0.01) this.zoom = 0.01;\n\n        this.canvas.zoomToPoint(\n          new fabric.Point(options.offsetX, options.offsetY),\n          this.zoom\n        );\n        opt.e.preventDefault();\n        opt.e.stopPropagation();\n      }\n    };\n\n    this.canvas.on('mouse:wheel', handleZoomEvent);\n\n    return () => {\n      this.canvas.off('mouse:wheel', handleZoomEvent);\n    };\n  }\n\n  initPanListener() {\n    let isPanning = false;\n\n    const mouseDown = (opt) => {\n      const { e: options } = opt;\n\n      /* Switch to pan mode on right-click, only if ctrl is not already pressed */\n      if (!this.ctrlPressed && (options.button === 2 || options.which === 3)) {\n        this.prevMode = this.mode;\n        this.enablePanMode();\n        this.rightClickDown = true;\n      }\n\n      if (this.mode == Mode.PAN) {\n        isPanning = true;\n        this.canvas.selection = false;\n        const options = opt.e as unknown as WheelEvent;\n        this.initialClientX = options.clientX;\n        this.initialClientY = options.clientY;\n      }\n    };\n\n    const mouseUp = (opt) => {\n      if (this.rightClickDown) {\n        this.rightClickDown = false;\n        if (this.prevMode === Mode.EDIT) {\n          this.enableEditMode();\n        }\n      }\n      isPanning = false;\n      this.canvas.selection = true;\n      const options = opt.e as unknown as WheelEvent;\n      this.initialClientX = options.clientX;\n      this.initialClientY = options.clientY;\n    };\n\n    const handlePan = (opt) => {\n      const options = opt.e as unknown as WheelEvent;\n      if (isPanning && options) {\n        const delta = new fabric.Point(options.movementX, options.movementY);\n        this.canvas.relativePan(delta);\n        this.finalClientX = options.clientX;\n        this.finalClientY = options.clientY;\n      }\n    };\n\n    this.canvas.on('mouse:down', mouseDown);\n    this.canvas.on('mouse:up', mouseUp);\n    this.canvas.on('mouse:move', handlePan);\n\n    return () => {\n      this.canvas.off('mouse:down', mouseDown);\n      this.canvas.off('mouse:up', mouseUp);\n      this.canvas.off('mouse:move', handlePan);\n    };\n  }\n\n  initPanSwipeListener() {\n    const handlePanSwipe = (opt) => {\n      const options = opt.e as unknown as WheelEvent;\n\n      // Condition for two-finger swipe on trackpad:\n      // 1. delta Y is an integer,\n      // 2. delta X is an integer,\n      // 3. ctrl key is not triggered\n      const trackpad_twofinger =\n        Number.isInteger(options.deltaY) &&\n        Number.isInteger(options.deltaX) &&\n        !options.ctrlKey;\n\n      if (trackpad_twofinger) {\n        const vpt = this.canvas.viewportTransform;\n        if (!vpt) return;\n        vpt[4] -= options.deltaX;\n        vpt[5] -= options.deltaY;\n        this.canvas.setViewportTransform(vpt);\n        this.canvas.requestRenderAll();\n      }\n    };\n\n    this.canvas.on('mouse:wheel', handlePanSwipe);\n\n    return () => {\n      this.canvas.off('mouse:wheel', handlePanSwipe);\n    };\n  }\n\n  initKeyPanningListener() {\n    document.addEventListener('keydown', (event) => {\n      if (!this.lockArrowKeys) {\n        if (event.key == 'ArrowUp') {\n          event.preventDefault();\n          this.canvas.relativePan(\n            new fabric.Point(0, 30 * this.canvas.getZoom())\n          );\n        } else if (event.key == 'ArrowDown') {\n          event.preventDefault();\n          this.canvas.relativePan(\n            new fabric.Point(0, -30 * this.canvas.getZoom())\n          );\n        } else if (event.key == 'ArrowLeft') {\n          event.preventDefault();\n          this.canvas.relativePan(\n            new fabric.Point(30 * this.canvas.getZoom(), 0)\n          );\n        } else if (event.key == 'ArrowRight') {\n          event.preventDefault();\n          this.canvas.relativePan(\n            new fabric.Point(-30 * this.canvas.getZoom(), 0)\n          );\n        }\n      }\n    });\n\n    return () => {\n      if (document.removeAllListeners) document.removeAllListeners('keydown');\n    };\n  }\n\n  enablePanMode() {\n    this.mode = Mode.PAN;\n    this.lockPostsMovement(true);\n    this.canvas.defaultCursor = 'grab';\n    this.canvas.hoverCursor = 'grab';\n  }\n\n  enableEditMode() {\n    this.mode = Mode.EDIT;\n    this.lockPostsMovement(false);\n    this.canvas.defaultCursor = 'default';\n    this.canvas.hoverCursor = 'move';\n  }\n\n  handleZoom(event) {\n    const center = this.canvas.getCenter();\n    let centerX = center.left + (this.finalClientX - this.initialClientX);\n    let centerY = center.top + (this.finalClientY - this.initialClientY);\n    this.initialClientX = this.finalClientX;\n    this.initialClientY = this.finalClientY;\n\n    if (event === 'zoomIn') {\n      this.zoom += 0.05;\n    } else if (event === 'zoomOut') {\n      this.zoom -= 0.05;\n    } else if (event === 'reset') {\n      this.zoom = 1;\n    } else if (event === 'setZoom') {\n      // this.zoom = this.zoom;\n      centerX = center.left;\n      centerY = center.top;\n    }\n\n    if (this.zoom > 20) {\n      this.zoom = 20;\n    } else if (this.zoom < 0.01) {\n      this.zoom = 0.01;\n    }\n\n    this.canvas.zoomToPoint(new fabric.Point(centerX, centerY), this.zoom);\n  }\n\n  hideListsWhenModalOpen() {\n    const subscription = this.dialog.afterOpened.subscribe(() => {\n      this.showList = false;\n      this.showBuckets = false;\n    });\n\n    return () => {\n      subscription.unsubscribe();\n    };\n  }\n\n  lockArrowKeysWhenModalOpen() {\n    const subscription = this.dialog.afterOpened.subscribe(() => {\n      this.lockArrowKeys = true;\n    });\n    return () => {\n      subscription.unsubscribe();\n    };\n  }\n\n  unlockArrowKeysWhenModalClose() {\n    const subscription = this.dialog.afterAllClosed.subscribe(() => {\n      this.lockArrowKeys = false;\n    });\n    return () => {\n      subscription.unsubscribe();\n    };\n  }\n\n  openTodoList() {\n    this.router.navigate([`/project/${this.projectID}/todo`]);\n  }\n\n  copyEmbedCode() {\n    const url = window.location.href + '?embedded=true';\n    navigator.clipboard.writeText(url);\n  }\n\n  copyPersonalEmbedCode() {\n    const url =\n      window.location.origin +\n      `/project/${this.projectID}/my-personal-board?embedded=true`;\n    navigator.clipboard.writeText(url);\n  }\n\n  private _openDialog(\n    component: ComponentType<unknown>,\n    data: any,\n    width = '700px'\n  ) {\n    this.dialog.open(component, {\n      maxWidth: 1280,\n      width: width,\n      autoFocus: false,\n      data: data,\n    });\n  }\n\n  private _calcUpvoteCounter() {\n    this.upvotesService\n      .getByBoardAndUser(this.boardID, this.user.userID)\n      .then((votes) => {\n        this.upvoteCounter = this.board.upvoteLimit - votes.length;\n      });\n  }\n\n  private _postsMovementAllowed() {\n    if (!this.user || !this.board) return false;\n\n    const isTeacher = this.user.role == Role.TEACHER;\n    const isStudent = this.user.role == Role.STUDENT;\n    const allowStudentMovement = this.board.permissions.allowStudentMoveAny;\n\n    return isTeacher || (isStudent && allowStudentMovement);\n  }\n\n  private _votingAllowed() {\n    const isStudent = this.user.role == Role.STUDENT;\n    const isTeacher = this.user.role == Role.TEACHER;\n    const allowStudent =\n      isStudent && this.board.permissions.allowStudentUpvoting;\n\n    return allowStudent || isTeacher;\n  }\n\n  async ngOnDestroy() {\n    this.unsubListeners.forEach((s) => s.unsubscribe());\n    this.socketService.disconnect(this.user.userID, this.boardID);\n    this.snackbarService.ngOnDestroy();\n  }\n}\n","<div>\n  <div>\n    <app-toolbar *ngIf=\"user && board && !embedded\" [user]=\"user\">\n      <span class=\"toolbarTitle\" *ngIf=\"board && board.name\">{{ board.name }}</span>\n      <button mat-icon-button (click)=\"openTaskDialog()\" matTooltip=\"Read Task\">\n        <mat-icon>task</mat-icon>\n      </button>\n      <button \n        mat-icon-button \n        *ngIf=\"user.role === Role.TEACHER\" \n        (click)=\"board.scope === BoardScope.PROJECT_SHARED ? copyEmbedCode() : copyPersonalEmbedCode()\" \n        matTooltip=\"Copy embeddable URL\"\n      >\n        <mat-icon>file_copy</mat-icon>\n      </button>\n      <span style=\"flex: 1 1 auto\"></span>\n      <app-view-navigation [boardID]=\"boardID\" [currentView]=\"viewType\"></app-view-navigation>\n      <div *ngIf=\"board\">\n        <app-notification-dropdown\n          [user]=\"user\"\n          [board]=\"board\"\n        ></app-notification-dropdown>\n      </div>\n      <app-toolbar-menu navbarMenu [board]=\"board\" [project]=\"project\"></app-toolbar-menu>\n    </app-toolbar>\n    <div class=\"canvas-area\">\n      <canvas id=\"canvas\" (window:resize)=\"onResize($event)\"></canvas>\n      <div class=\"top-embedded-board-name\" *ngIf=\"user && board && embedded\">\n        {{ board.name }}\n      </div>\n      <div class=\"top-nav\" *ngIf=\"!embedded\">\n        <a routerLink=\"{{ '/project/' + projectID }}\">Back to Project</a>\n      </div>\n      <div class=\"bottom-nav\">\n        <a>{{ upvoteCounter }} upvotes remaining!</a>\n      </div>\n      <div class=\"toolSection\">\n        <div class=\"toolField\">\n          <button\n            *ngIf=\"mode !== modeType.CHOOSING_LOCATION\"\n            [disabled]=\"\n              board &&\n              user &&\n              !board.permissions.allowStudentEditAddDeletePost &&\n              user.role === Role.STUDENT\n            \"\n            mat-fab\n            color=\"accent\"\n            matTooltip=\"Add Post\"\n            matTooltipPosition=\"before\"\n            (click)=\"handleCreatePost()\"\n          >\n            <mat-icon>add</mat-icon>\n          </button>\n          <button\n            *ngIf=\"mode === modeType.CHOOSING_LOCATION\"\n            mat-fab\n            color=\"accent\"\n            matTooltip=\"Cancel Post\"\n            matTooltipPosition=\"before\"\n            (click)=\"disableChooseLocation()\"\n          >\n            <mat-icon>close</mat-icon>\n          </button>\n          <button\n            *ngIf=\"mode === modeType.EDIT\"\n            mat-fab\n            color=\"accent\"\n            matTooltip=\"Switch to Move Posts Mode\"\n            matTooltipPosition=\"before\"\n            (click)=\"enablePanMode()\"\n          >\n          <span style=\"padding-left: 1px;\" class=\"material-symbols-outlined\">\n            arrow_selector_tool\n          </span>\n          </button>\n          <button\n            *ngIf=\"mode === modeType.PAN\"\n            mat-fab\n            color=\"accent\"\n            matTooltip=\"Switch to Pan Mode (Right-click/Ctrl+click)\"\n            matTooltipPosition=\"before\"\n            (click)=\"enableEditMode()\"\n          >\n            <mat-icon style=\"padding-right: 3px;\">pan_tool</mat-icon>\n          </button>\n        </div>\n      </div>\n      <div class=\"zoomField\">\n        <button\n          mat-icon-button\n          (click)=\"handleZoom('zoomOut')\"\n          class=\"zoomButton\"\n          aria-label=\"Zoom out\"\n        >\n          <mat-icon>remove</mat-icon>\n        </button>\n        <span aria-label=\"Current zoom level\"\n          >{{ Math.round(this.zoom * 100) }}%</span\n        >\n        <button\n          mat-icon-button\n          (click)=\"handleZoom('zoomIn')\"\n          class=\"zoomButton\"\n          aria-label=\"Zoom in\"\n        >\n          <mat-icon>add</mat-icon>\n        </button>\n        <button\n          mat-icon-button\n          (click)=\"handleZoom('reset')\"\n          class=\"zoomButton\"\n          aria-label=\"Reset zoom\"\n        >\n          <mat-icon>refresh</mat-icon>\n        </button>\n      </div>\n    </div>\n  </div>\n</div>"]},"metadata":{},"sourceType":"module","externalDependencies":[]}